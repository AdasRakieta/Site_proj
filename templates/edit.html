{% extends "base.html" %}

{% block title %}SmartHome - Edycja Kontrolek{% endblock %}
{% block header %}Edycja Kontrolek{% endblock %}

{% block content %}
    <div class="edit-mode-buttons">
        <button id="editModeButton" class="edit-mode-button">Tryb edycji</button>
        
    </div>

    <!-- Panel kontrolny do dodawania -->
    <div class="control-panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Dodawanie pokoju -->
            <div class="add-room-container">
                <h3 class="add-room-h3">Dodaj nowy pokój</h3>
                <div class="add-room-div" style="display: flex; gap: 10px;">
                    <input class="add-room-input" type="text" id="newRoomName" placeholder="Nazwa pokoju..." >
                </div>
                <button style="margin-top: 10px;" class="add-room-btn" onclick="window.addNewRoom()">+</button>
            </div>

            <!-- Dodawanie urządzenia -->
            <div class="add-device-container">
                <h3 class="add-room-h3">Dodaj nowe urządzenie</h3>
                <div class="add-device-div" style="display: flex; flex-direction: column; gap: 10px;">
                    <input class="add-device-input" type="text" id="newDeviceName" placeholder="Nazwa urządzenia...">
                    <select class="add-device-select" id="newDeviceType">
                        <option value="light">Światło</option>
                        <option value="thermostat">Termostat</option>
                    </select>
                    <select class="add-device-select" id="newDeviceRoom">
                        <option value="">Nieprzypisane</option>
                        <!-- Lista pokoi będzie dodana przez JS -->
                    </select>
                    <button class="add-device-btn" onclick="window.addNewDevice()">+</button>
                </div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <button id="saveModeButton" class="edit-mode-button save">Zapisz</button>
            <button id="cancelModeButton" class="edit-mode-button cancel">Anuluj</button>
        </div>
    </div>

    <!-- Kanban -->
    <div class="drag-container" style="display: flex; justify-content: center; width: 100%;">
        <div id="kanbanContainer" class="drag-list" style="width: 100%; max-width: 1400px; margin: 0 auto;"></div>
    </div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ URL_PREFIX }}{{ url_for('static', filename='css/dragNdrop.css') }}?v={{ asset_version }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
<script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/dragNdrop.js') }}"></script>
<script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/controls.js') }}"></script>

<!-- Preloaded Kanban data as JSON (avoids JS parser errors on Jinja) -->
<script id="preloaded-kanban-data" type="application/json">
{
  "rooms": {{ rooms|tojson }},
  "buttons": {{ buttons|tojson }},
  "temperature_controls": {{ temperature_controls|tojson }}
}
</script>

<script>
    // Parse preloaded JSON from the dedicated script tag to avoid JS linter errors
    let preloadedRooms = [];
    let preloadedButtons = [];
    let preloadedControls = [];
    (function() {
        const el = document.getElementById('preloaded-kanban-data');
        if (el) {
            try {
                const data = JSON.parse(el.textContent || '{}');
                preloadedRooms = Array.isArray(data.rooms) ? data.rooms : [];
                preloadedButtons = Array.isArray(data.buttons) ? data.buttons : [];
                preloadedControls = Array.isArray(data.temperature_controls) ? data.temperature_controls : [];
            } catch (e) {
                console.error('Failed to parse preloaded kanban data:', e);
            }
        }
    })();

    // Ensure devices have type property for proper rendering
    if (Array.isArray(preloadedButtons)) {
        preloadedButtons.forEach(button => {
            if (button && !button.type) button.type = 'light';
        });
    }
    if (Array.isArray(preloadedControls)) {
        preloadedControls.forEach(control => {
            if (control && !control.type) control.type = 'thermostat';
        });
    }

    // Override loadKanban once to render preloaded data, then restore original function
    (function() {
        const originalLoadKanban = window.loadKanban;
        window.loadKanban = function() {
            console.log('First-call preloaded Kanban render');
            if (window.updateRoomSelect) {
                window.updateRoomSelect(preloadedRooms || []);
            }
            if (window.renderKanbanLists) {
                window.renderKanbanLists(preloadedRooms || [], preloadedButtons || [], preloadedControls || []);
            }
            // Restore the original loadKanban for subsequent calls (which fetch fresh data)
            if (typeof originalLoadKanban === 'function') {
                window.loadKanban = originalLoadKanban;
            }
        };
    })();
</script>
{% endblock %}
