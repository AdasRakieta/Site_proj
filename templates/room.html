{% extends "base.html" %}

{% block title %}SmartHome - {{ room }}{% endblock %}
{% block header %}{{ room }}{% endblock %}

{% block content %}
    <h2>Przyciski w pokoju:</h2>
    <div class="lights-room-container">
        <div id="buttonsContainer" class="center-container">
            {% if buttons %}
                {% for button in buttons %}
                    <div class="light-control">
                        <label class="room-lable">{{ button.name }}</label>
                        <label class="switch">
                            <input type="checkbox" id="{{ button.name.replace(' ', '_') }}Switch" {% if button.state %}checked{% endif %}>
                            <span class="slider" id="room"></span>
                        </label>
                    </div>
                {% endfor %}
            {% else %}
                <p>Brak przycisków w tym pokoju.</p>
            {% endif %}
        </div>
    </div>

    <h2>Kontrolki temperatury:</h2>
    <div class="temp-container">
        <div id="temperatureControlsContainer">
            {% if temperature_controls %}
                {% for control in temperature_controls %}
                <div class="control-item">
                    <span>{{ control.name }}:</span>
                    <input class="input-temp" type="number" id="temp{{ control.name.replace(' ', '') }}" 
                           name="temp{{ control.name.replace(' ', '') }}" min="16" max="30" 
                           placeholder="22" value="{{ control.temperature }}">
                    <button class="control-button">Ustaw</button>
                </div>
                {% endfor %}
            {% else %}
                <p>Brak kontrolek temperatury w tym pokoju.</p>
            {% endif %}
        </div>
    </div>

    <div class="center-container"> 
        <a href="/" class="rooms-button">Wróć</a>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const room = "{{ room }}";
        
        // Inicjalizacja przełączników
        const switches = document.querySelectorAll('.switch input[type="checkbox"]');
        switches.forEach(switchElement => {
            switchElement.addEventListener('change', function() {
                const buttonName = this.id.replace('Switch', '').replace(/_/g, ' ');
                const state = this.checked;
                
                if (app.socket && app.socket.connected) {
                    // Primary method: Use WebSocket
                    app.socket.emit('toggle_button', { room: room, name: buttonName, state: state });
                } else {
                    // Fallback method: Use REST API
                    console.log('WebSocket not available, using REST API fallback');
                    toggleButtonViaAPI(room, buttonName, state);
                }
            });
        });

        // Inicjalizacja kontrolek temperatury
        document.querySelectorAll('.control-button').forEach(button => {
            button.addEventListener('click', function() {
                const controlName = this.parentElement.querySelector('span').textContent.replace(':', '').trim();
                const tempInput = document.getElementById(`temp${controlName.replace(/\s+/g, '')}`);
                const tempValue = parseInt(tempInput.value, 10);

                if (isNaN(tempValue) || tempValue < 16 || tempValue > 30) {
                    alert('Proszę wprowadzić poprawną temperaturę (16-30).');
                    return;
                }

                if (app.socket && app.socket.connected) {
                    // Primary method: Use WebSocket
                    app.socket.emit('set_temperature', { name: controlName, temperature: tempValue });
                } else {
                    // Fallback method: Use REST API
                    console.log('WebSocket not available, using REST API fallback');
                    setTemperatureViaAPI(controlName, tempValue);
                }
            });
        });

        // Pobierz kontrolki temperatury dla danego pokoju
        app.socket.emit('get_room_temperature_controls', room);

        // Nasłuchuj na aktualizacje stanu przycisków
        app.socket.on('update_button', function(data) {
            const switchElement = document.getElementById(`${data.name.replace(/\s+/g, '_')}Switch`);
            if (switchElement) {
                switchElement.checked = data.state;
            }
        });

        // Nasłuchuj na aktualizacje kontrolek temperatury
        app.socket.on('update_room_temperature_controls', function(controls) {
            const container = document.getElementById('temperatureControlsContainer');
            container.innerHTML = '';
            
            if(controls && controls.length > 0){
                controls.forEach(control => {
                    const controlDiv = document.createElement('div');
                    controlDiv.classList.add('control-item');

                    const controlName = document.createElement('span');
                    controlName.textContent = `${control.name}:`;
                    controlDiv.appendChild(controlName);

                    const input = document.createElement('input');
                    input.className = 'input-temp';
                    input.type = 'number';
                    input.id = `temp${control.name.replace(/\s+/g, '')}`;
                    input.name = `temp${control.name.replace(/\s+/g, '')}`;
                    input.min = '16';
                    input.max = '30';
                    input.placeholder = '22';
                    input.value = control.temperature || 22;
                    controlDiv.appendChild(input);

                    const button = document.createElement('button');
                    button.className = 'control-button';
                    button.textContent = 'Ustaw';
                    button.addEventListener('click', () => {
                        const tempValue = parseInt(input.value, 10);
                        if (!isNaN(tempValue) && tempValue >= 16 && tempValue <= 30) {
                            if (app.socket && app.socket.connected) {
                                // Primary method: Use WebSocket
                                app.socket.emit('set_temperature', { name: control.name, temperature: tempValue });
                            } else {
                                // Fallback method: Use REST API
                                console.log('WebSocket not available, using REST API fallback');
                                setTemperatureViaAPI(control.name, tempValue);
                            }
                        }
                    });
                    controlDiv.appendChild(button);

                    container.appendChild(controlDiv);
                });
            } else {
                container.innerHTML = '<p>Brak kontrolek temperatury w tym pokoju.</p>';
            }
        });
    });

    // Helper functions for REST API fallback
    async function toggleButtonViaAPI(room, buttonName, state) {
        try {
            // Find button ID first
            const buttons = await app.fetchData('/api/buttons');
            const button = buttons.find(b => b.name === buttonName && b.room === room);
            
            if (!button) {
                console.error('Button not found:', buttonName, 'in room:', room);
                if (window.showNotification) {
                    window.showNotification('Nie znaleziono przycisku', 'error');
                }
                return;
            }
            
            // Call the toggle API
            const response = await fetch(`/api/buttons/${button.id}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ state: state })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Update the UI manually since we're not using WebSocket
                const switchElement = document.getElementById(`${buttonName.replace(/\s+/g, '_')}Switch`);
                if (switchElement) {
                    switchElement.checked = state;
                }
                
                if (window.showNotification) {
                    window.showNotification(`${buttonName} ${state ? 'włączony' : 'wyłączony'}`, 'success');
                }
            } else {
                console.error('Failed to toggle button:', result.message);
                if (window.showNotification) {
                    window.showNotification('Błąd przełączania przycisku: ' + result.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error toggling button via API:', error);
            if (window.showNotification) {
                window.showNotification('Błąd przełączania przycisku', 'error');
            }
        }
    }

    async function setTemperatureViaAPI(controlName, temperature) {
        try {
            // Find temperature control ID first
            const controls = await app.fetchData('/api/temperature_controls');
            const control = controls.find(c => c.name === controlName && c.room === room);
            
            if (!control) {
                console.error('Temperature control not found:', controlName, 'in room:', room);
                if (window.showNotification) {
                    window.showNotification('Nie znaleziono termostatu', 'error');
                }
                return;
            }
            
            const response = await fetch(`/api/temperature_controls/${control.id}/temperature`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ temperature: temperature })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Update the UI manually since we're not using WebSocket
                const input = document.getElementById(`temp${controlName.replace(/\s+/g, '')}`);
                if (input) {
                    input.value = temperature;
                }
                
                if (window.showNotification) {
                    window.showNotification(`Temperatura ${controlName} ustawiona na ${temperature}°C`, 'success');
                }
            } else {
                console.error('Failed to set temperature:', result.message);
                if (window.showNotification) {
                    window.showNotification('Błąd ustawiania temperatury: ' + result.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error setting temperature via API:', error);
            if (window.showNotification) {
                window.showNotification('Błąd ustawiania temperatury', 'error');
            }
        }
    }

    // Helper function to get CSRF token
    function getCSRFToken() {
        let token = null;
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) token = meta.getAttribute('content');
        
        if (!token) {
            const input = document.querySelector('input[name="_csrf_token"]');
            if (input) token = input.value;
        }
        
        if (!token && window.csrf_token) {
            token = window.csrf_token;
        }
        
        return token;
    }
</script>
{% endblock %}