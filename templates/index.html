{% extends "base.html" %}

{% block title %}SmartHome - Strona Główna{% endblock %}
{% block header %}Strona Główna{% endblock %}

{% block content %}
    <!-- Karta zarządzania domami -->
    <div class="home-management-card">
        <div class="card-header">
            <h3>🏠 {{ current_home.name if current_home else 'Nie wybrano domu' }}</h3>
            <p class="current-home-info">
                {% if current_home %}
                    Zarządzasz obecnie domem: <strong>{{ current_home.name }}</strong>
                {% else %}
                    Wybierz dom, którym chcesz zarządzać
                {% endif %}
            </p>
        </div>
        <div class="card-actions">
            <a href="/home/select" class="quick-action-btn">
                <span class="action-icon">🏠</span>
                <span class="action-text">Zarządzaj domami</span>
            </a>
            {% if current_home %}
            <div class="home-stats-quick">
                <span class="stat-item">{{ current_home.room_count or 0 }} pokoi</span>
                <span class="stat-item">{{ current_home.device_count or 0 }} urządzeń</span>
            </div>
            {% endif %}
        </div>
    </div>

    <h3 style="margin-bottom: 25px;">Wybierz pokój, którym chcesz sterować</h3>
    <div class="rooms-container" id="roomSelect">
        <!-- Rooms will be dynamically added here -->
    </div>
    <div id="tempNow" class="temp-cont">
        <label>Aktualna Temperatura w </label>
        <label id="statShow"></label>
        <label id="tempShow">Ładowanie...</label>
    </div>
    <button id="toggleMap"  class="map-button">Pokaż mapę</button>
    <div id="map-container" style="display: none;">
        <h3>Nasze miejsca</h3>
        <div id="map"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Pre-loaded rooms from server
    const preloadedRooms = {{ rooms|tojson }};
    
    document.addEventListener('DOMContentLoaded', function () {
        // Use pre-loaded rooms instead of making AJAX call
        renderRooms(preloadedRooms);
        startTemperatureAutoRefresh();
    });
    
    function renderRooms(rooms) {
        const roomSelect = document.getElementById('roomSelect');
        roomSelect.innerHTML = '';
        
        // Adjust container width based on room count
        if (rooms.length > 8) {
            roomSelect.classList.add('wide');
        } else {
            roomSelect.classList.remove('wide');
        }

        // Determine how many rooms per row based on total count
        const roomsPerRow = rooms.length > 8 ? 3 : 2;

        for (let i = 0; i < rooms.length; i += roomsPerRow) {
            const row = document.createElement('div');
            row.className = roomsPerRow === 3 ? 'grid-container-list' : 'grid-container';

            // Create and add buttons for each room in this row
            for (let j = 0; j < roomsPerRow && i + j < rooms.length; j++) {
                const roomButton = document.createElement('a');
                roomButton.href = `/${rooms[i + j].toLowerCase()}`;
                roomButton.className = 'rooms-button';
                roomButton.textContent = rooms[i + j];
                row.appendChild(roomButton);
            }

            roomSelect.appendChild(row);
            const hr = document.createElement('hr');
            roomSelect.appendChild(hr);
        }
    }
    
    function loadRooms() {
        // Fallback to AJAX if needed (e.g., for real-time updates)
        app.getRooms().then(rooms => {
            renderRooms(rooms);
        });
    }

    function fetchTemperature() {
        app.fetchData('/weather')
            .then(data => {
                const stationElement = document.getElementById('statShow');
                const temperatureElement = document.getElementById('tempShow');

                if (data.stacja && data.temperatura) {
                    stationElement.textContent = `${data.stacja}: `;
                    temperatureElement.textContent = `${data.temperatura} °C`;
                } else {
                    stationElement.textContent = 'Brak danych';
                    temperatureElement.textContent = '';
                }
            })
            .catch(error => {
                console.error('Błąd podczas pobierania danych pogodowych:', error);
                document.getElementById('statShow').textContent = 'Błąd pobierania';
                document.getElementById('tempShow').textContent = '';
            });
    }

    function startTemperatureAutoRefresh() {
        fetchTemperature();
        setInterval(fetchTemperature, 300000);
    }

    app.onRoomsUpdate = function(rooms) {
        loadRooms();
    };
</script>
{% endblock %}