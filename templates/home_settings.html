{% extends "base.html" %}

{% block title %}Ustawienia Domu - {{ home.name }} - SmartHome{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home_settings.css') }}?v={{ asset_version }}">
{% endblock %}

{% block content %}
<div class="home-settings-container">
    <div class="settings-header">
        <div class="header-left">
            <h1>‚öôÔ∏è Ustawienia Domu</h1>
            <h2>{{ home.name }}</h2>
            {% if home.description %}
            <p class="home-description">{{ home.description }}</p>
            {% endif %}
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-number">{{ home.room_count or 0 }}</span>
                    <span class="stat-label">Pokoje</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">{{ home.device_count or 0 }}</span>
                    <span class="stat-label">UrzƒÖdzenia</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">{{ home.user_count or 1 }}</span>
                    <span class="stat-label">U≈ºytkownicy</span>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-sections">
        <!-- Sekcja podstawowych informacji o domu -->
        <section class="settings-section">
            <div class="section-header">
                <h3>üè† Informacje o domu</h3>
                <p class="section-description">ZarzƒÖdzaj podstawowymi informacjami o twoim domu</p>
            </div>
            <div class="section-content">
                <form id="homeInfoForm" class="settings-form">
                    <div class="form-group">
                        <label for="homeName">Nazwa domu</label>
                        <input type="text" id="homeName" name="name" value="{{ home.name }}" 
                               class="form-control" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label for="homeDescription">Opis domu</label>
                        <textarea style="border-color: var(--accent);" id="homeDescription" name="description" 
                                  class="form-control" rows="3" maxlength="500"
                                  placeholder="Opcjonalny opis domu...">{{ home.description or '' }}</textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary" style="margin: auto;">
                            Zapisz zmiany
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Sekcja lokalizacji domu -->
        <section class="settings-section">
            <div class="section-header">
                <h3>üìç Lokalizacja domu</h3>
                <p class="section-description">Ustaw lokalizacjƒô domu w Polsce - precyzyjne wsp√≥≈Çrzƒôdne geograficzne zostanƒÖ automatycznie okre≈õlone</p>
            </div>
            <div class="section-content">
                <form id="homeLocationForm" class="settings-form">
                    <!-- City selection with autocomplete -->
                    <div class="form-group autocomplete-wrapper">
                        <label for="homeCity">Miasto *</label>
                        <input type="text" id="homeCity" name="city" value="{{ home.city or '' }}" 
                               class="form-control" autocomplete="off" maxlength="255" 
                               placeholder="Zacznij pisaƒá nazwƒô miasta..." required>
                        <div id="citySuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    <small class="form-text" style="margin-top: -15px; margin-bottom: 15px;" >Wybierz miasto z listy - wsp√≥≈Çrzƒôdne zostanƒÖ ustawione automatycznie</small>
                    
                    <!-- Street -->
                    <div class="form-group">
                        <label for="homeStreet">Ulica</label>
                        <input type="text" id="homeStreet" name="street" value="{{ home.street or '' }}" 
                               class="form-control" maxlength="255" 
                               placeholder="np. Marsza≈Çkowska">
                        <small class="form-text">Podanie ulicy i numeru pozwala uzyskaƒá dok≈Çadniejsze wsp√≥≈Çrzƒôdne</small>
                    </div>
                    
                    <!-- House number and apartment -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="homeHouseNumber">Numer domu</label>
                            <input type="text" id="homeHouseNumber" name="house_number" 
                                   value="{{ home.house_number or '' }}" 
                                   class="form-control" maxlength="20" 
                                   placeholder="np. 1, 12A, 5/7">
                        </div>
                        <div class="form-group">
                            <label for="homeApartmentNumber">Numer mieszkania</label>
                            <input type="text" id="homeApartmentNumber" name="apartment_number" 
                                   value="{{ home.apartment_number or '' }}" 
                                   class="form-control" maxlength="20" 
                                   placeholder="np. 15, opcjonalnie">
                        </div>
                    </div>
                    
                    <!-- Postal code and country -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="homePostalCode">Kod pocztowy</label>
                            <input type="text" id="homePostalCode" name="postal_code" 
                                   value="{{ home.postal_code or '' }}" 
                                   class="form-control" maxlength="10" 
                                   placeholder="XX-XXX"
                                   pattern="[0-9]{2}-[0-9]{3}">
                            <small class="form-text">Format: XX-XXX (np. 00-001)</small>
                        </div>
                        <div class="form-group">
                            <label for="homeCountry">Kraj</label>
                            <input type="text" id="homeCountry" name="country" value="Poland" 
                                   class="form-control" readonly>
                        </div>
                    </div>
                    
                    <!-- Coordinates (read-only, auto-filled) -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="homeLatitude">Szeroko≈õƒá geograficzna</label>
                            <input type="text" id="homeLatitude" name="latitude" 
                                   value="{{ '%.6f'|format(home.latitude) if home.latitude else '' }}" 
                                   class="form-control" readonly>
                            <small class="form-text">Automatycznie okre≈õlana na podstawie adresu</small>
                        </div>
                        <div class="form-group">
                            <label for="homeLongitude">D≈Çugo≈õƒá geograficzna</label>
                            <input type="text" id="homeLongitude" name="longitude" 
                                   value="{{ '%.6f'|format(home.longitude) if home.longitude else '' }}" 
                                   class="form-control" readonly>
                            <small class="form-text">Automatycznie okre≈õlana na podstawie adresu</small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="useMyLocationBtn" class="btn-primary">
                            üìç U≈ºyj mojej lokalizacji
                        </button>
                        <button type="submit" class="btn-primary">
                            Zapisz lokalizacjƒô
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Sekcja zaawansowanych ustawie≈Ñ -->
        <section class="settings-section danger-zone">
            <div class="section-header">
                <h3>‚ö†Ô∏è Strefa niebezpieczna</h3>
                <p class="section-description">Nieodwracalne akcje dotyczƒÖce domu</p>
            </div>
            <div class="section-content">
                <div class="danger-actions">
                    <div class="danger-action">
                        <div class="action-info">
                            <h4>Usu≈Ñ dom</h4>
                            <p>Trwale usu≈Ñ ten dom i wszystkie zwiƒÖzane z nim dane. Ta akcja jest nieodwracalna.</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="deleteHomeBtn" onclick="confirmDeleteHome(event)">
                        <span id="deleteHomeBtnText">Usu≈Ñ dom</span>
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Navigation back -->
    <div class="settings-footer">
        <button onclick="window.location.href='/home/select'" class="btn-primary">
             ‚Üê Powr√≥t do wyboru domu
        </button>
    </div>
</div>

<!-- Home data for JavaScript -->
<div id="home-data" 
     data-home-id="{{ home.id }}" 
     data-home-name="{{ home.name }}"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/home_settings.js') }}"></script>
<script>
// Notification function - override for this page to have custom styling
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
        color: ${type === 'warning' ? '#000' : 'white'};
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: ${type === 'warning' ? '400px' : '300px'};
        white-space: pre-line;
        word-wrap: break-word;
        font-size: ${type === 'warning' ? '14px' : '15px'};
        line-height: ${type === 'warning' ? '1.4' : '1.5'};
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Set display time based on type (longer for warnings due to more content)
    const displayTime = type === 'warning' ? 6000 : 4000;
    
    // Auto remove after specified time
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, displayTime);
}

// Make confirmDeleteHome available globally for onclick handler
window.confirmDeleteHome = confirmDeleteHome;
</script>
{% endblock %}