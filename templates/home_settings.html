{% extends "base.html" %}

{% block title %}Ustawienia Domu - {{ home.name }} - SmartHome{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home_settings.css') }}">
{% endblock %}

{% block content %}
<div class="home-settings-container">
    <div class="settings-header">
        <div class="header-left">
            <h1>‚öôÔ∏è Ustawienia Domu</h1>
            <h2>{{ home.name }}</h2>
            {% if home.description %}
            <p class="home-description">{{ home.description }}</p>
            {% endif %}
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-number">{{ home.room_count or 0 }}</span>
                    <span class="stat-label">Pokoje</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">{{ home.device_count or 0 }}</span>
                    <span class="stat-label">UrzƒÖdzenia</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">{{ home.user_count or 1 }}</span>
                    <span class="stat-label">U≈ºytkownicy</span>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-sections">
        <!-- Sekcja podstawowych informacji o domu -->
        <section class="settings-section">
            <div class="section-header">
                <h3>üè† Informacje o domu</h3>
                <p class="section-description">ZarzƒÖdzaj podstawowymi informacjami o twoim domu</p>
            </div>
            <div class="section-content">
                <form id="homeInfoForm" class="settings-form">
                    <div class="form-group">
                        <label for="homeName">Nazwa domu</label>
                        <input type="text" id="homeName" name="name" value="{{ home.name }}" 
                               class="form-control" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label for="homeDescription">Opis domu</label>
                        <textarea style="border-color: var(--accent);" id="homeDescription" name="description" 
                                  class="form-control" rows="3" maxlength="500"
                                  placeholder="Opcjonalny opis domu...">{{ home.description or '' }}</textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary" style="margin: auto;">
                            Zapisz zmiany
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Sekcja zaawansowanych ustawie≈Ñ -->
        <section class="settings-section danger-zone">
            <div class="section-header">
                <h3>‚ö†Ô∏è Strefa niebezpieczna</h3>
                <p class="section-description">Nieodwracalne akcje dotyczƒÖce domu</p>
            </div>
            <div class="section-content">
                <div class="danger-actions">
                    <div class="danger-action">
                        <div class="action-info">
                            <h4>Usu≈Ñ dom</h4>
                            <p>Trwale usu≈Ñ ten dom i wszystkie zwiƒÖzane z nim dane. Ta akcja jest nieodwracalna.</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="deleteHomeBtn" onclick="confirmDeleteHome(event)">
                        <span id="deleteHomeBtnText">Usu≈Ñ dom</span>
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Navigation back -->
    <div class="settings-footer">
        <button onclick="window.location.href='/home/select'" class="btn-primary">
            Powr√≥t do wyboru domu
        </button>
    </div>
</div>

<!-- Home data for JavaScript -->
<div id="home-data" 
     data-home-id="{{ home.id }}" 
     data-home-name="{{ home.name }}"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/home_settings.js') }}"></script>
<script>
// Get home ID from data attribute
const homeElement = document.getElementById('home-data');
const homeId = homeElement.dataset.homeId;

// Home info form handler
document.getElementById('homeInfoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        description: formData.get('description')
    };
    
    // API call to update home info using new endpoint
    fetch(`/api/home/${homeId}/info/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Informacje o domu zosta≈Çy zaktualizowane', 'success');
        } else {
            showNotification(result.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji', 'error');
    });
});

// Invite user form handler
document.getElementById('inviteUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        email: formData.get('email'),
        role: formData.get('role')
    };
    
    // API call to invite user using new endpoint
    fetch(`/api/home/${homeId}/users/invite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Zaproszenie zosta≈Ço wys≈Çane', 'success');
            this.reset();
        } else {
            showNotification(result.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania zaproszenia', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania zaproszenia', 'error');
    });
});

function confirmDeleteHome(event) {
    const button = event.currentTarget;
    const buttonText = document.getElementById('deleteHomeBtnText');
    const homeName = '{{ home.name }}';
    
    // Je≈õli przycisk ju≈º jest w stanie potwierdzenia
    if (button.classList.contains('confirm-state')) {
        // Wy≈ÇƒÖcz przycisk i poka≈º status
        button.disabled = true;
        buttonText.textContent = 'Usuwanie...';
        
        // Call delete API
        fetch(`/api/home/${homeId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('Dom zosta≈Ç usuniƒôty', 'success');
                // Redirect to home selection after deletion
                setTimeout(() => {
                    window.location.href = '/home/select';
                }, 2000);
            } else {
                showNotification(result.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania domu', 'error');
                button.disabled = false;
                buttonText.textContent = 'Usu≈Ñ dom';
                button.classList.remove('confirm-state');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania domu', 'error');
            button.disabled = false;
            buttonText.textContent = 'Usu≈Ñ dom';
            button.classList.remove('confirm-state');
        });
    } else {
        // Pierwszy klik - pobierz informacje i zmie≈Ñ na stan potwierdzenia
        fetch(`/api/home/${homeId}/deletion-info`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const info = result.data;
                // Poka≈º informacjƒô o tym co zostanie usuniƒôte
                showNotification(
                    `Usuniecie "${homeName}" usunie: ${info.room_count} pokoi, ${info.device_count} urzƒÖdze≈Ñ, ${info.user_count} u≈ºytkownik√≥w, ${info.automation_count} automatyzacji. Kliknij ponownie aby potwierdziƒá.`,
                    'warning'
                );
                
                // Zmie≈Ñ przycisk na stan potwierdzenia
                button.classList.add('confirm-state');
                buttonText.textContent = '‚úì Potwierd≈∫ usuniƒôcie';
                
                // Resetuj po 5 sekundach
                setTimeout(() => {
                    if (button.classList.contains('confirm-state')) {
                        button.classList.remove('confirm-state');
                        buttonText.textContent = 'Usu≈Ñ dom';
                    }
                }, 5000);
            } else {
                showNotification('Nie mo≈ºna pobraƒá informacji o domu', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas pobierania informacji', 'error');
        });
    }
}

// Notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
        color: ${type === 'warning' ? '#000' : 'white'};
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 300px;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 4000);
}
</script>
{% endblock %}