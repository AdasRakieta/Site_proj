{% extends "base.html" %}

{% block title %}SmartHome - Ustawienia{% endblock %}
{% block header %}Ustawienia{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v={{ asset_version }}">
{% endblock %}

{% block content %}
    <div class="settings-container">
        <!-- Sekcja zarzƒÖdzania domami -->
        <section class="settings-section">
            <h2>üè† ZarzƒÖdzanie domami</h2>
            <p class="section-description">ZarzƒÖdzaj swoimi domami, tw√≥rz nowe i zapraszaj u≈ºytkownik√≥w</p>
            <div class="settings-actions">
                <a href="/home/select" class="settings-btn settings-btn-primary">
                    <i class="icon">üè†</i>
                    <div class="btn-content">
                        <span class="btn-title">Centrum zarzƒÖdzania domami</span>
                        <span class="btn-description">Prze≈ÇƒÖczaj miƒôdzy domami, tw√≥rz nowe i zarzƒÖdzaj dostƒôpem</span>
                    </div>
                    <i class="arrow">‚Üí</i>
                </a>
            </div>
        </section>

        <!-- Sekcja motywu aplikacji -->
        <section class="settings-section">
            <h2>üé® Motyw aplikacji</h2>
            <p class="section-description">Dostosuj wyglƒÖd aplikacji do swoich preferencji</p>
            <label for="theme-select">Wybierz motyw:</label>
            <select id="theme-select" class="select-settings" onchange="app.changeTheme(this.value)">
                <option value="light">Jasny</option>
                <option value="dark">Ciemny</option>
            </select>
            
        </section>

        <!-- Sekcja informacji o koncie -->
        <section class="settings-section">
            <h2>üë§ Informacje o koncie</h2>
            <p class="section-description">Podstawowe informacje o Twoim koncie</p>
            <div class="account-info">
                <div class="info-item">
                    <span class="info-label">U≈ºytkownik:</span>
                    <span class="info-value">{{ user_data.name if user_data else session.username }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{ user_data.email if user_data else 'Brak danych' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Rola:</span>
                    <span class="info-value role-badge role-{{ session.role }}">{{ session.role.title() if session.role else 'U≈ºytkownik' }}</span>
                </div>
            </div>
        </section>

        <!-- Sekcja zarzƒÖdzania u≈ºytkownikami (tylko sys-admin) -->
        {% if all_users %}
        <section class="settings-section">
            <h2>üë• Wszyscy u≈ºytkownicy systemu</h2>
            <p class="section-description">Lista wszystkich zarejestrowanych u≈ºytkownik√≥w</p>
            <div class="users-list">
                <div class="users-table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nazwa</th>
                                <th>Email</th>
                                <th>Rola</th>
                                <th>Liczba dom√≥w</th>
                                <th>Data utworzenia</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in all_users %}
                            <tr>
                                <td class="user-name">{{ user.name }}</td>
                                <td class="user-email">{{ user.email }}</td>
                                <td>
                                    {% if user.role == 'sys-admin' %}
                                        <span class="role-badge role-sys-admin">System Admin</span>
                                    {% elif user.role == 'admin' %}
                                        <span class="role-badge role-admin">Admin</span>
                                    {% else %}
                                        <span class="role-badge role-user">U≈ºytkownik</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ user.home_count }}</td>
                                <td class="user-date">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Nieznane' }}</td>
                                <td class="text-center">
                                    {% if user.role != 'sys-admin' %}
                                        <button onclick="deleteUser('{{ user.id }}', '{{ user.name }}', event)" 
                                                class="delete-user-btn" 
                                                title="Usu≈Ñ u≈ºytkownika">
                                            üóëÔ∏è Usu≈Ñ
                                        </button>
                                    {% else %}
                                        <span style="color: #95a5a6; font-size: 12px;">‚Äî</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="users-stats">
                    <p><strong>≈ÅƒÖcznie u≈ºytkownik√≥w:</strong> {{ all_users|length }}</p>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Sekcja zg≈Çaszania b≈Çƒôd√≥w -->
        <section class="settings-section bug-report-section">
            <h2>üêõ Zg≈Ço≈õ b≈ÇƒÖd</h2>
            <p class="section-description">Pom√≥≈º nam ulepszyƒá aplikacjƒô - zg≈Ço≈õ napotkany problem</p>
            
            <form id="bug-report-form" class="bug-report-form">
                <div class="form-group">
                    <label for="bug-title">Tytu≈Ç zg≈Çoszenia *</label>
                    <input type="text" id="bug-title" name="title" class="form-input" 
                           placeholder="Kr√≥tki opis problemu" required maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="bug-description">Opis problemu *</label>
                    <textarea id="bug-description" name="description" class="form-textarea" 
                              placeholder="Opisz szczeg√≥≈Çowo napotkany problem..." 
                              required rows="6" maxlength="2000"></textarea>
                    <span class="char-count">0 / 2000</span>
                </div>
                
                <div class="form-info">
                    <p>‚ÑπÔ∏è Twoje zg≈Çoszenie zostanie wys≈Çane mailem do administratora systemu oraz utworzone jako issue w projekcie na GitHubie (je≈õli skonfigurowano).</p>
                </div>
                
                <button type="submit" class="submit-btn" id="bug-submit-btn">
                    <span class="btn-icon">üì§</span>
                    <span class="btn-text">Wy≈õlij zg≈Çoszenie</span>
                </button>
                
                <div id="bug-report-status" class="status-message" style="display: none;"></div>
            </form>
        </section>
    </div>
{% endblock %}

{% block scripts %}
<script>
  window.sessionRole = "{{ session.role }}";
  
  // Funkcja usuwania u≈ºytkownika z dwuetapowym potwierdzeniem
  function deleteUser(userId, userName, event) {
      const button = event.currentTarget;
      
      // Je≈õli przycisk ju≈º jest w stanie potwierdzenia
      if (button.classList.contains('confirm-state')) {
          // Wy≈õlij ≈ºƒÖdanie usuniƒôcia
          button.disabled = true;
          button.textContent = '‚è≥ Usuwanie...';
          
          fetch(`/api/users/${userId}`, {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json'
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Usu≈Ñ wiersz z tabeli
                  const row = button.closest('tr');
                  row.style.opacity = '0';
                  row.style.transition = 'opacity 0.3s ease';
                  setTimeout(() => {
                      row.remove();
                      // Aktualizuj licznik
                      updateUserCount();
                  }, 300);
                  
                  // Poka≈º komunikat sukcesu
                  showNotification('U≈ºytkownik zosta≈Ç usuniƒôty', 'success');
              } else {
                  button.disabled = false;
                  button.textContent = 'üóëÔ∏è Usu≈Ñ';
                  button.classList.remove('confirm-state');
                  showNotification(data.error || 'B≈ÇƒÖd podczas usuwania u≈ºytkownika', 'error');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              button.disabled = false;
              button.textContent = 'üóëÔ∏è Usu≈Ñ';
              button.classList.remove('confirm-state');
              showNotification('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem', 'error');
          });
      } else {
          // Pierwszy klik - zmie≈Ñ na stan potwierdzenia
          button.classList.add('confirm-state');
          button.textContent = '‚úì Potwierd≈∫';
          
          // Resetuj po 3 sekundach
          setTimeout(() => {
              if (button.classList.contains('confirm-state')) {
                  button.classList.remove('confirm-state');
                  button.textContent = 'üóëÔ∏è Usu≈Ñ';
              }
          }, 3000);
      }
  }
  
  // Funkcja aktualizacji licznika u≈ºytkownik√≥w
  function updateUserCount() {
      const tbody = document.querySelector('.users-table tbody');
      const count = tbody ? tbody.querySelectorAll('tr').length : 0;
      const statsElement = document.querySelector('.users-stats p');
      if (statsElement) {
          statsElement.innerHTML = `<strong>≈ÅƒÖcznie u≈ºytkownik√≥w:</strong> ${count}`;
      }
  }
  
  // Funkcja wy≈õwietlania powiadomie≈Ñ
  function showNotification(message, type = 'info') {
      // Usu≈Ñ poprzednie powiadomienie je≈õli istnieje
      const existing = document.querySelector('.notification-toast');
      if (existing) {
          existing.remove();
      }
      
      // Utw√≥rz nowe powiadomienie
      const notification = document.createElement('div');
      notification.className = `notification-toast notification-${type}`;
      notification.textContent = message;
      
      // Dodaj style
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '15px 20px';
      notification.style.borderRadius = '8px';
      notification.style.zIndex = '10000';
      notification.style.fontWeight = '500';
      notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      notification.style.animation = 'slideIn 0.3s ease';
      
      if (type === 'success') {
          notification.style.background = '#27ae60';
          notification.style.color = 'white';
      } else if (type === 'error') {
          notification.style.background = '#e74c3c';
          notification.style.color = 'white';
      } else {
          notification.style.background = '#3498db';
          notification.style.color = 'white';
      }
      
      document.body.appendChild(notification);
      
      // Usu≈Ñ po 3 sekundach
      setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
      }, 3000);
  }
  
  // Dodaj animacje CSS
  const style = document.createElement('style');
  style.textContent = `
      @keyframes slideIn {
          from {
              transform: translateX(400px);
              opacity: 0;
          }
          to {
              transform: translateX(0);
              opacity: 1;
          }
      }
      
      @keyframes slideOut {
          from {
              transform: translateX(0);
              opacity: 1;
          }
          to {
              transform: translateX(400px);
              opacity: 0;
          }
      }
  `;
  document.head.appendChild(style);

  // Bug report form handling
  const bugReportForm = document.getElementById('bug-report-form');
  const bugDescription = document.getElementById('bug-description');
  const charCount = document.querySelector('.char-count');
  const bugSubmitBtn = document.getElementById('bug-submit-btn');
  const bugReportStatus = document.getElementById('bug-report-status');

  // Character counter
  if (bugDescription && charCount) {
      bugDescription.addEventListener('input', function() {
          const length = this.value.length;
          charCount.textContent = `${length} / 2000`;
          if (length > 1900) {
              charCount.style.color = '#e74c3c';
          } else {
              charCount.style.color = '#7f8c8d';
          }
      });
  }

  // Form submission
  if (bugReportForm) {
      bugReportForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const title = document.getElementById('bug-title').value.trim();
          const description = document.getElementById('bug-description').value.trim();
          
          if (!title || !description) {
              showBugReportStatus('Wype≈Çnij wszystkie wymagane pola', 'error');
              return;
          }
          
          // Disable button and show loading state
          bugSubmitBtn.disabled = true;
          const btnText = bugSubmitBtn.querySelector('.btn-text');
          const originalText = btnText.textContent;
          btnText.textContent = 'Wysy≈Çanie...';
          bugSubmitBtn.style.opacity = '0.6';
          
          // Send request
          fetch('/api/bug-report', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  title: title,
                  description: description
              })
          })
          .then(response => response.json())
          .then(data => {
              bugSubmitBtn.disabled = false;
              btnText.textContent = originalText;
              bugSubmitBtn.style.opacity = '1';
              
              if (data.success) {
                  let message = '‚úì Zg≈Çoszenie wys≈Çane pomy≈õlnie!';
                  
                  if (data.email_sent && data.github_issue_created) {
                      message += ' Email wys≈Çany i issue utworzone na GitHubie.';
                  } else if (data.email_sent) {
                      message += ' Email wys≈Çany do administratora.';
                  } else if (data.github_issue_created) {
                      message += ' Issue utworzone na GitHubie.';
                  }
                  
                  // Use DOM manipulation instead of innerHTML to prevent XSS
                  const statusDiv = document.getElementById('bug-report-status');
                  statusDiv.textContent = message;
                  
                  if (data.github_issue_url) {
                      const link = document.createElement('a');
                      link.href = data.github_issue_url;
                      link.target = '_blank';
                      link.rel = 'noopener noreferrer';
                      link.style.color = '#3498db';
                      link.style.textDecoration = 'underline';
                      link.style.marginLeft = '5px';
                      link.textContent = 'Zobacz issue';
                      statusDiv.appendChild(document.createTextNode(' '));
                      statusDiv.appendChild(link);
                  }
                  
                  statusDiv.className = 'status-message status-success';
                  statusDiv.style.display = 'block';
                  showBugReportStatus(message, 'success');
                  
                  // Clear form
                  bugReportForm.reset();
                  if (charCount) {
                      charCount.textContent = '0 / 2000';
                      charCount.style.color = '#7f8c8d';
                  }
                  
                  // Show notification
                  showNotification('Zg≈Çoszenie wys≈Çane pomy≈õlnie', 'success');
              } else {
                  showBugReportStatus(data.error || 'Nie uda≈Ço siƒô wys≈Çaƒá zg≈Çoszenia', 'error');
                  showNotification('B≈ÇƒÖd wysy≈Çania zg≈Çoszenia', 'error');
              }
          })
          .catch(error => {
              bugSubmitBtn.disabled = false;
              btnText.textContent = originalText;
              bugSubmitBtn.style.opacity = '1';
              
              console.error('Error:', error);
              showBugReportStatus('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem', 'error');
              showNotification('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem', 'error');
          });
      });
  }

  function showBugReportStatus(message, type) {
      bugReportStatus.innerHTML = message;
      bugReportStatus.className = `status-message status-${type}`;
      bugReportStatus.style.display = 'block';
      
      // Auto-hide after 10 seconds for success, 15 for error
      const timeout = type === 'success' ? 10000 : 15000;
      setTimeout(() => {
          bugReportStatus.style.opacity = '0';
          setTimeout(() => {
              bugReportStatus.style.display = 'none';
              bugReportStatus.style.opacity = '1';
          }, 300);
      }, timeout);
  }
</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}