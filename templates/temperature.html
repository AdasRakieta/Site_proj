{% extends "base.html" %}

{% block title %}SmartHome - Temperatura{% endblock %}
{% block header %}Temperatura{% endblock %}

{% block content %}
    <main>
        <div id="temperatureControlsContainer">
            <!-- Kontrolki temperatury będą ładowane dynamicznie -->
        </div>
    </main>

    <script>
        function initPage() {
            console.log('Inicjalizacja strony temperatury');
            
            if (!window.app) {
                console.error('Aplikacja nie została zainicjalizowana');
                return;
            }

            // Funkcja aktualizująca kontrolki temperatury
            function updateTemperatureControls(controls) {
                const container = document.getElementById('temperatureControlsContainer');
                if (!container) return;
                
                container.innerHTML = '';

                // Grupowanie kontrolek według pokoju
                const controlsByRoom = controls.reduce((acc, control) => {
                    if (!acc[control.room]) {
                        acc[control.room] = [];
                    }
                    acc[control.room].push(control);
                    return acc;
                }, {});

                // Iteracja przez pokoje
                Object.entries(controlsByRoom).forEach(([room, roomControls], roomIndex) => {
                    const roomContainer = document.createElement('div');
                    roomContainer.classList.add('temp-container');

                    const roomHeader = document.createElement('h2');
                    roomHeader.textContent = `${room}:`;
                    roomContainer.appendChild(roomHeader);

                    const controlsContainer = document.createElement('div');
                    controlsContainer.classList.add('center-container');

                    roomControls.forEach(control => {
                        const controlDiv = document.createElement('div');
                        controlDiv.classList.add('control-item');

                        // Nagłówek z przełącznikiem enabled
                        const controlHeader = document.createElement('div');
                        controlHeader.className = 'control-header';

                        const controlNameSpan = document.createElement('span');
                        controlNameSpan.textContent = `${control.name}:`;
                        controlHeader.appendChild(controlNameSpan);

                        const switchLabel = document.createElement('label');
                        switchLabel.className = 'switch temp-switch';
                        
                        const switchInput = document.createElement('input');
                        switchInput.type = 'checkbox';
                        switchInput.id = `${control.name.replace(/\s+/g, '_')}EnabledSwitch`;
                        switchInput.checked = control.enabled !== false;
                        
                        const slider = document.createElement('span');
                        slider.className = 'slider mini';
                        slider.title = 'Włącz/Wyłącz termostat';
                        
                        switchLabel.appendChild(switchInput);
                        switchLabel.appendChild(slider);
                        controlHeader.appendChild(switchLabel);
                        controlDiv.appendChild(controlHeader);

                        // Zawartość kontrolki
                        const controlContent = document.createElement('div');
                        controlContent.className = 'control-content';
                        if (!switchInput.checked) {
                            controlContent.classList.add('disabled');
                        }

                        const input = document.createElement('input');
                        input.className = 'input-temp';
                        input.type = 'number';
                        input.id = `temp${control.name.replace(/\s+/g, '')}`;
                        input.min = '16';
                        input.max = '30';
                        input.placeholder = '22';
                        input.value = control.temperature || 22;
                        input.disabled = !switchInput.checked;
                        controlContent.appendChild(input);

                        const button = document.createElement('button');
                        button.className = 'control-button';
                        button.textContent = 'Ustaw';
                        button.disabled = !switchInput.checked;
                        button.addEventListener('click', async () => {
                            const tempValue = parseInt(input.value, 10);
                            if (!isNaN(tempValue)) {
                                if (app.socket && app.socket.connected) {
                                    // Primary method: Use WebSocket
                                    app.socket.emit('set_temperature', { 
                                        name: control.name, 
                                        temperature: tempValue,
                                        room: control.room
                                    });
                                } else {
                                    // Fallback method: Use REST API
                                    console.log('WebSocket not available, using REST API fallback');
                                    await setTemperatureViaAPI(control, tempValue);
                                }
                            }
                        });
                        controlContent.appendChild(button);
                        controlDiv.appendChild(controlContent);

                        // Event listener dla przełącznika enabled
                        switchInput.addEventListener('change', function() {
                            const enabled = this.checked;
                            
                            if (enabled) {
                                input.disabled = false;
                                button.disabled = false;
                                controlContent.classList.remove('disabled');
                            } else {
                                input.disabled = true;
                                button.disabled = true;
                                controlContent.classList.add('disabled');
                            }
                            
                            if (app.socket && app.socket.connected) {
                                app.socket.emit('toggle_temperature_control_enabled', { 
                                    room: control.room, 
                                    name: control.name, 
                                    enabled: enabled 
                                });
                            } else {
                                console.log('WebSocket not available, using REST API fallback');
                                toggleTemperatureEnabledViaAPI(control.name, enabled);
                            }
                        });

                        controlsContainer.appendChild(controlDiv);
                    });

                    roomContainer.appendChild(controlsContainer);
                    container.appendChild(roomContainer);
                });
            }

            // Nasłuchuj aktualizacji kontrolek temperatury
            app.onTemperatureControlsUpdate = function(controls) {
                updateTemperatureControls(controls);
            };

            // Nasłuchuj synchronizacji temperatury
            app.socket.on('sync_temperature', function(data) {
                const input = document.getElementById(`temp${data.name.replace(/\s+/g, '')}`);
                if (input) input.value = data.temperature;
            });

            // Nasłuchuj na aktualizacje stanu enabled termostatów
            app.socket.on('update_temperature_control_enabled', function(data) {
                const switchElement = document.getElementById(`${data.name.replace(/\s+/g, '_')}EnabledSwitch`);
                if (switchElement) {
                    switchElement.checked = data.enabled;
                    
                    // Zaktualizuj stan UI
                    const controlItem = switchElement.closest('.control-item');
                    const controlContent = controlItem.querySelector('.control-content');
                    const tempInput = controlContent.querySelector('input');
                    const button = controlContent.querySelector('button');
                    
                    if (data.enabled) {
                        tempInput.disabled = false;
                        button.disabled = false;
                        controlContent.classList.remove('disabled');
                    } else {
                        tempInput.disabled = true;
                        button.disabled = true;
                        controlContent.classList.add('disabled');
                    }
                }
            });

            // Fallback function to set temperature via REST API
            async function setTemperatureViaAPI(control, temperature) {
                try {
                    const response = await fetch(`/api/temperature_controls/${control.id}/temperature`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ temperature: temperature })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update the UI manually since we're not using WebSocket
                        const input = document.getElementById(`temp${control.name.replace(/\s+/g, '')}`);
                        if (input) {
                            input.value = temperature;
                        }
                        
                        if (window.showNotification) {
                            window.showNotification(`Temperatura ${control.name} ustawiona na ${temperature}°C`, 'success');
                        }
                    } else {
                        console.error('Failed to set temperature:', result.message);
                        if (window.showNotification) {
                            window.showNotification('Błąd ustawiania temperatury: ' + result.message, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error setting temperature via API:', error);
                    if (window.showNotification) {
                        window.showNotification('Błąd ustawiania temperatury', 'error');
                    }
                }
            }

            // Fallback function to toggle temperature enabled via REST API
            async function toggleTemperatureEnabledViaAPI(controlName, enabled) {
                try {
                    const controls = await app.fetchData('/api/temperature_controls');
                    const control = controls.find(c => c.name === controlName);
                    
                    if (!control) {
                        console.error('Temperature control not found:', controlName);
                        if (window.showNotification) {
                            window.showNotification('Nie znaleziono termostatu', 'error');
                        }
                        return;
                    }
                    
                    const response = await fetch(`/api/temperature_controls/${control.id}/enabled`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ enabled: enabled })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        if (window.showNotification) {
                            window.showNotification(`Termostat ${controlName} ${enabled ? 'włączony' : 'wyłączony'}`, 'success');
                        }
                    } else {
                        console.error('Failed to toggle temperature control enabled:', result.message);
                        if (window.showNotification) {
                            window.showNotification('Błąd przełączania termostatu: ' + result.message, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error toggling temperature control enabled via API:', error);
                    if (window.showNotification) {
                        window.showNotification('Błąd przełączania termostatu', 'error');
                    }
                }
            }

            // Helper function to get CSRF token
            function getCSRFToken() {
                let token = null;
                const meta = document.querySelector('meta[name="csrf-token"]');
                if (meta) token = meta.getAttribute('content');
                
                if (!token) {
                    const input = document.querySelector('input[name="_csrf_token"]');
                    if (input) token = input.value;
                }
                
                if (!token && window.csrf_token) {
                    token = window.csrf_token;
                }
                
                return token;
            }

            // Pobierz początkowe dane
            app.fetchData('/api/temperature_controls')
                .then(response => {
                    console.log('Temperature controls API response:', response);
                    if (response && response.status === 'success' && response.data) {
                        updateTemperatureControls(response.data);
                    } else if (response && Array.isArray(response)) {
                        // Fallback for direct array response
                        updateTemperatureControls(response);
                    } else {
                        console.error('Invalid temperature controls response:', response);
                    }
                })
                .catch(error => console.error('Błąd:', error));

            app.socket.emit('get_temperatures');
        }
    </script>
</body>
</html>
{% endblock %}