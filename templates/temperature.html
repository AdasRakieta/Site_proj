{% extends "base.html" %}

{% block title %}SmartHome - Temperatura{% endblock %}
{% block header %}Temperatura{% endblock %}

{% block content %}
    <main>
        <div id="temperatureControlsContainer">
            <!-- Kontrolki temperatury będą ładowane dynamicznie -->
        </div>
    </main>

    <script>
        function initPage() {
            console.log('Inicjalizacja strony temperatury');
            
            if (!window.app) {
                console.error('Aplikacja nie została zainicjalizowana');
                return;
            }

            // Funkcja aktualizująca kontrolki temperatury
            function updateTemperatureControls(controls) {
                const container = document.getElementById('temperatureControlsContainer');
                if (!container) return;
                
                container.innerHTML = '';

                // Grupowanie kontrolek według pokoju
                const controlsByRoom = controls.reduce((acc, control) => {
                    if (!acc[control.room]) {
                        acc[control.room] = [];
                    }
                    acc[control.room].push(control);
                    return acc;
                }, {});

                // Iteracja przez pokoje
                Object.entries(controlsByRoom).forEach(([room, roomControls], roomIndex) => {
                    const roomContainer = document.createElement('div');
                    roomContainer.classList.add('temp-container');

                    const roomHeader = document.createElement('h2');
                    roomHeader.textContent = `${room}:`;
                    roomContainer.appendChild(roomHeader);

                    const controlsContainer = document.createElement('div');
                    controlsContainer.classList.add('center-container');

                    roomControls.forEach(control => {
                        const controlDiv = document.createElement('div');
                        controlDiv.classList.add('control-item');

                        const controlName = document.createElement('span');
                        controlName.textContent = `${control.name}:`;
                        controlDiv.appendChild(controlName);

                        const input = document.createElement('input');
                        input.className = 'input-temp';
                        input.type = 'number';
                        input.id = `temp${control.name.replace(/\s+/g, '')}`;
                        input.min = '16';
                        input.max = '30';
                        input.placeholder = '22';
                        input.value = control.temperature || 22;
                        controlDiv.appendChild(input);

                        const button = document.createElement('button');
                        button.className = 'control-button';
                        button.textContent = 'Ustaw';
                        button.addEventListener('click', async () => {
                            const tempValue = parseInt(input.value, 10);
                            if (!isNaN(tempValue)) {
                                if (app.socket && app.socket.connected) {
                                    // Primary method: Use WebSocket
                                    app.socket.emit('set_temperature', { 
                                        name: control.name, 
                                        temperature: tempValue,
                                        room: control.room
                                    });
                                } else {
                                    // Fallback method: Use REST API
                                    console.log('WebSocket not available, using REST API fallback');
                                    await setTemperatureViaAPI(control, tempValue);
                                }
                            }
                        });
                        controlDiv.appendChild(button);

                        controlsContainer.appendChild(controlDiv);
                    });

                    roomContainer.appendChild(controlsContainer);
                    container.appendChild(roomContainer);
                });
            }

            // Nasłuchuj aktualizacji kontrolek temperatury
            app.onTemperatureControlsUpdate = function(controls) {
                updateTemperatureControls(controls);
            };

            // Nasłuchuj synchronizacji temperatury
            app.socket.on('sync_temperature', function(data) {
                const input = document.getElementById(`temp${data.name.replace(/\s+/g, '')}`);
                if (input) input.value = data.temperature;
            });

            // Fallback function to set temperature via REST API
            async function setTemperatureViaAPI(control, temperature) {
                try {
                    const response = await fetch(`/api/temperature_controls/${control.id}/temperature`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ temperature: temperature })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update the UI manually since we're not using WebSocket
                        const input = document.getElementById(`temp${control.name.replace(/\s+/g, '')}`);
                        if (input) {
                            input.value = temperature;
                        }
                        
                        if (window.showNotification) {
                            window.showNotification(`Temperatura ${control.name} ustawiona na ${temperature}°C`, 'success');
                        }
                    } else {
                        console.error('Failed to set temperature:', result.message);
                        if (window.showNotification) {
                            window.showNotification('Błąd ustawiania temperatury: ' + result.message, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error setting temperature via API:', error);
                    if (window.showNotification) {
                        window.showNotification('Błąd ustawiania temperatury', 'error');
                    }
                }
            }

            // Helper function to get CSRF token
            function getCSRFToken() {
                let token = null;
                const meta = document.querySelector('meta[name="csrf-token"]');
                if (meta) token = meta.getAttribute('content');
                
                if (!token) {
                    const input = document.querySelector('input[name="_csrf_token"]');
                    if (input) token = input.value;
                }
                
                if (!token && window.csrf_token) {
                    token = window.csrf_token;
                }
                
                return token;
            }

            // Pobierz początkowe dane
            app.fetchData('/api/temperature_controls')
                .then(controls => {
                    if (controls) updateTemperatureControls(controls);
                })
                .catch(error => console.error('Błąd:', error));

            app.socket.emit('get_temperatures');
        }
    </script>
</body>
</html>
{% endblock %}