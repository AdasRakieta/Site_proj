{% extends "base.html" %}

{% block title %}SmartHome - Zabezpieczenia{% endblock %}
{% block header %}Zabezpieczenia{% endblock %}

{% block content %}
    <div class="security-container">
        <h3 style="margin-top: -5px;">Alarm</h3>
        <div class="button-group">
            <button class="control-button" id="enableSecurity">Załącz czuwanie</button>
            <button class="control-button" id="disableSecurity">Wyłącz czuwanie</button>
        </div>
        <p id="securityStatus" class="status-text">Aktualny status: Nieznany</p>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    function initSecurityPage() {
        // Pobierz początkowy status zabezpieczeń
        if (window.app && window.app.socket) {
            window.app.socket.emit('get_security_state');
        }

        // Podpięcie przycisków
        document.getElementById('enableSecurity').addEventListener('click', () => {
            if (window.app && window.app.socket) {
                window.app.socket.emit('set_security_state', { state: 'Załączony' });
            }
        });

        document.getElementById('disableSecurity').addEventListener('click', () => {
            if (window.app && window.app.socket) {
                window.app.socket.emit('set_security_state', { state: 'Wyłączony' });
            }
        });
    }

    // Inicjalizuj gdy DOM jest gotowy i aplikacja jest załadowana
    document.addEventListener('DOMContentLoaded', function() {
        // Sprawdź czy app jest już dostępny
        if (window.app) {
            initSecurityPage();
        } else {
            // Czekaj aż app będzie dostępny
            let attempts = 0;
            const maxAttempts = 50; // 5 sekund
            const waitForApp = () => {
                if (window.app && window.app.socket) {
                    initSecurityPage();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(waitForApp, 100);
                } else {
                    console.error('Nie udało się zainicjalizować aplikacji w czasie 5 sekund');
                }
            };
            waitForApp();
        }
    });
</script>
{% endblock %}