{% extends "base.html" %}

{% block title %}SmartHome - Dashboard Administratora{% endblock %}
{% block header %}Dashboard Administratora{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v={{ asset_version }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-grid">
        <!-- Statystyki systemu -->
        <div class="dashboard-card">
            <h3>Statystyki Systemu</h3>
            <div class="stat-row">
                <span class="stat-label">Użytkownicy:</span>
                <span class="stat-value" id="users-count">{{ stats.users_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Urządzenia:</span>
                <span class="stat-value" id="devices-count">{{ stats.devices_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Automatyzacje:</span>
                <span class="stat-value" id="automations-count">{{ stats.automations_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Aktywne automatyzacje:</span>
                <span class="stat-value" id="active-automations">{{ stats.active_automations }}</span>
            </div>
        </div>

        <!-- Wykres zużycia energii -->
        <div class="dashboard-card">
            <h3>Zużycie Energii</h3>
            <div class="chart-container">
                <canvas id="energyChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Dzisiaj:</span>
                <span class="stat-value" id="energy-today">{{ stats.energy_today }} kWh</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ten miesiąc:</span>
                <span class="stat-value" id="energy-month">{{ stats.energy_month }} kWh</span>
            </div>
        </div>

        <!-- Historia stanów urządzeń -->
        <div class="dashboard-card">
            <h3>Stany Urządzeń</h3>
            <button class="refresh-btn" onclick="refreshDeviceStates(true)">Odśwież</button>
            <div class="device-list" id="device-states">
                {% for device in device_states %}
                <div class="device-item">
                    <span>{{ device.name }} ({{ device.room }})</span>
                    <span class="device-status {{ 'online' if device.state else 'offline' }}">
                        {{ 'Włączone' if device.state else 'Wyłączone' }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Statystyki automatyzacji -->
        <div class="dashboard-card">
            <h3>Automatyzacje</h3>
            <div class="chart-container">
                <canvas id="automationChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Wykonane dzisiaj:</span>
                <span class="stat-value" id="automations-today">{{ stats.automations_executed_today }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Błędy:</span>
                <span class="stat-value" id="automation-errors">{{ stats.automation_errors }}</span>
            </div>
        </div>
    </div>

    <!-- Logi zarządzania -->
    <div class="dashboard-card">
        <h3>Logi Zarządzania</h3>
        <div style="margin-bottom: 15px;">
            <button class="refresh-btn" onclick="refreshLogs(true)">Odśwież logi</button>
            <button class="refresh-btn" onclick="showLogManagement()" style="background: #ffc107; margin-left: 10px;">Zarządzanie logami</button>
        </div>
        
        <!-- Log Management Panel (initially hidden) -->
        <div id="log-management-panel" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 4px;">
            <h4>Zarządzanie logami</h4>
            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <label>Usuń logi starsze niż:</label>
                <input type="number" id="delete-days" placeholder="liczba dni" min="1" class="input-settings" style="width: 100px;">
                <span>dni</span>
                <button id="delete-days-btn" onclick="confirmDeleteByDays(event)" class="confirm-delete-btn">
                    <span id="delete-days-text">Usuń</span>
                </button>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Usuń logi z okresu:</label><br>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="date" id="delete-start-date" class="input-settings">
                    <span>do</span>
                    <input type="date" id="delete-end-date" class="input-settings">
                    <button id="delete-range-btn" onclick="confirmDeleteByRange(event)" class="confirm-delete-btn">
                        <span id="delete-range-text">Usuń</span>
                    </button>
                </div>
            </div>
            <div>
                <button id="clear-all-btn" onclick="confirmClearAll(event)" class="confirm-delete-btn" style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                    <span id="clear-all-text">Wyczyść wszystkie logi</span>
                </button>
                <button onclick="hideLogManagement()" class="rooms-button">Zamknij</button>
            </div>
        </div>
        
        <div class="logs-container" id="logs-container">
            {% for log in management_logs %}
            <div class="log-entry">
                <span class="log-timestamp">{{ log.timestamp }}</span>
                <span class="log-level {{ log.level }}">{{ log.level|upper }}</span>
                <span class="log-message">{{ log.message }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- User Management Section -->
    <div class="dashboard-card">
        <h3>Zarządzanie użytkownikami</h3>
        <div class="user-management">
            <div class="user-form">
                <h4>Wyślij zaproszenie</h4>
                <form id="inviteUserForm">
                    <div class="new-user-form">
                        <input class="input-settings-add-user" type="email" id="inviteEmail" name="email" placeholder="Email" required>
                        <select class="select-settings-add-user" id="inviteRole" name="role">
                            <option value="member">User</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <button class="rooms-button" type="submit">Wyślij zaproszenie</button>
                    </div>
                </form>
                
                <!-- Lista oczekujących zaproszeń -->
                <div style="margin-top: 20px;">
                    <h5 style="margin-bottom: 10px;">Oczekujące zaproszenia</h5>
                    <div id="pendingInvitationsContainer" style="max-height: 200px; overflow-y: auto;">
                        <!-- Będzie wypełnione dynamicznie -->
                    </div>
                </div>
            </div>
            <div class="user-form">
                <h4>Lista użytkowników</h4>
                <div id="userActionMessage" class="alert-msg" style="display: none;"></div>
                <div class="user-table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nazwa</th>
                                <th>E-mail</th>
                                <th>Rola</th>
                                <th>Akcje</th>
                            </tr>
                            <tr style="font-size: 11px; color: #999;">
                                <th colspan="4" style="text-align: left; padding: 5px 10px;">
                                    <em>Właściciel nie może być usunięty z domu</em>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Tabela będzie wypełniona dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Management Section -->
    <div class="dashboard-card">
        <h3>Powiadomienia</h3>
        <div class="user-management two-column">
            <div class="user-form">
                <h4>Dodaj odbiorcę powiadomień</h4>
                <div class="new-user-form">
                    <input class="input-settings-add-user" type="email" id="notificationRecipientEmail" placeholder="e-mail" required>
                    <select class="select-settings-add-user" id="notificationRecipientUser"></select>
                    <button type="button" id="addNotificationRecipientBtn" class="rooms-button">Dodaj</button>
                </div>
                <div id="notificationsMessage" class="alert-msg" style="display: none;"></div>
            </div>
            <div class="user-form">
                <h4>Lista odbiorców powiadomień</h4>
                <div class="user-table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>E-mail</th>
                                <th>Użytkownik</th>
                                <th>Powiadomienia</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="notificationRecipientsTableBody">
                            <!-- Tabela będzie wypełniona dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Session role data -->
<script>
    window.sessionRole = "{{ session.role }}";
</script>

<!-- Embed preloaded JSON data safely -->
<script id="preloadedDeviceStates" type="application/json">{{ device_states | tojson | safe }}</script>
<script id="preloadedManagementLogs" type="application/json">{{ management_logs | tojson | safe }}</script>
<script id="preloadedUsers" type="application/json">{{ preloaded_users | tojson | safe }}</script>

<!-- Hidden elements to store template data -->
<div id="stats-data" 
     data-automations-today="{{ stats.automations_executed_today|default(0) }}" 
     data-automation-errors="{{ stats.automation_errors|default(0) }}" 
     style="display: none;"></div>

<div id="dashboard-home-id" 
     data-home-id="{{ session.current_home_id }}"
     style="display: none;"></div>

<!-- Load dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Invite form submission handler -->
<script>
document.getElementById('inviteUserForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('inviteEmail').value.trim();
    const role = document.getElementById('inviteRole').value;
    const homeIdElement = document.getElementById('dashboard-home-id');
    const homeId = homeIdElement?.dataset.homeId;
    
    if (!homeId) {
        showNotification('Najpierw wybierz dom', 'error');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Wysyłanie...';
    
    fetch(`/api/home/${homeId}/invite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, role })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Zaproszenie zostało wysłane!', 'success');
            document.getElementById('inviteEmail').value = '';
            loadPendingInvitations();
        } else {
            showNotification(result.error || 'Wystąpił błąd podczas wysyłania zaproszenia', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Wystąpił błąd podczas wysyłania zaproszenia', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
    });
});
</script>
{% endblock %}