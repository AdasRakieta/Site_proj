{% extends "base.html" %}

{% block title %}SmartHome - Dashboard Administratora{% endblock %}
{% block header %}Dashboard Administratora{% endblock %}

{% block additional_styles %}
<style>
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.dashboard-card {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.dashboard-card h3 {
    margin-top: 0;
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.stat-label {
    font-weight: bold;
    color: var(--text-secondary);
}

.stat-value {
    color: var(--text-primary);
}

.chart-container {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--background-secondary);
    border-radius: 4px;
    margin: 10px 0;
    position: relative;
}

.chart-placeholder {
    color: var(--text-secondary);
    font-style: italic;
}

.logs-container {
    max-height: 300px;
    overflow-y: auto;
    background: var(--background-secondary);
    border-radius: 4px;
    padding: 10px;
}

.log-entry {
    padding: 8px;
    margin: 5px 0;
    background: var(--card-background);
    border-radius: 4px;
    border-left: 3px solid var(--accent-color);
    font-family: monospace;
    font-size: 0.9em;
}

.log-timestamp {
    color: var(--text-secondary);
    font-weight: bold;
}

.log-level {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
    margin: 0 5px;
}

.log-level.info {
    background: #d1ecf1;
    color: #0c5460;
}

.log-level.warning {
    background: #fff3cd;
    color: #856404;
}

.log-level.error {
    background: #f8d7da;
    color: #721c24;
}

.refresh-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 10px;
}

.refresh-btn:hover {
    background: var(--accent-hover);
}

.device-list {
    max-height: 200px;
    overflow-y: auto;
}

.device-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    background: var(--background-secondary);
    border-radius: 4px;
}

.device-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.device-status.online {
    background: #d4edda;
    color: #155724;
}

.device-status.offline {
    background: #f8d7da;
    color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-grid">
        <!-- Statystyki systemu -->
        <div class="dashboard-card">
            <h3>Statystyki Systemu</h3>
            <div class="stat-row">
                <span class="stat-label">Użytkownicy:</span>
                <span class="stat-value" id="users-count">{{ stats.users_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Urządzenia:</span>
                <span class="stat-value" id="devices-count">{{ stats.devices_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Automatyzacje:</span>
                <span class="stat-value" id="automations-count">{{ stats.automations_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Aktywne automatyzacje:</span>
                <span class="stat-value" id="active-automations">{{ stats.active_automations }}</span>
            </div>
        </div>

        <!-- Wykres zużycia energii -->
        <div class="dashboard-card">
            <h3>Zużycie Energii</h3>
            <div class="chart-container">
                <canvas id="energyChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Dzisiaj:</span>
                <span class="stat-value" id="energy-today">{{ stats.energy_today }} kWh</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ten miesiąc:</span>
                <span class="stat-value" id="energy-month">{{ stats.energy_month }} kWh</span>
            </div>
        </div>

        <!-- Historia stanów urządzeń -->
        <div class="dashboard-card">
            <h3>Stany Urządzeń</h3>
            <button class="refresh-btn" onclick="refreshDeviceStates()">Odśwież</button>
            <div class="device-list" id="device-states">
                {% for device in device_states %}
                <div class="device-item">
                    <span>{{ device.name }} ({{ device.room }})</span>
                    <span class="device-status {{ 'online' if device.state else 'offline' }}">
                        {{ 'Włączone' if device.state else 'Wyłączone' }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Statystyki automatyzacji -->
        <div class="dashboard-card">
            <h3>Automatyzacje</h3>
            <div class="chart-container">
                <canvas id="automationChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Wykonane dzisiaj:</span>
                <span class="stat-value" id="automations-today">{{ stats.automations_executed_today }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Błędy:</span>
                <span class="stat-value" id="automation-errors">{{ stats.automation_errors }}</span>
            </div>
        </div>
    </div>

    <!-- Logi zarządzania -->
    <div class="dashboard-card">
        <h3>Logi Zarządzania</h3>
        <div style="margin-bottom: 15px;">
            <button class="refresh-btn" onclick="refreshLogs()">Odśwież logi</button>
            <button class="refresh-btn" onclick="showLogManagement()" style="background: #ffc107; margin-left: 10px;">Zarządzanie logami</button>
        </div>
        
        <!-- Log Management Panel (initially hidden) -->
        <div id="log-management-panel" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--background-secondary); border-radius: 4px;">
            <h4>Zarządzanie logami</h4>
            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <label>Usuń logi starsze niż:</label>
                <input type="number" id="delete-days" placeholder="liczba dni" min="1" class="input-settings" style="width: 100px;">
                <span>dni</span>
                <button id="delete-days-btn" onclick="showDeleteDaysConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Usuń</button>
                <button id="delete-days-confirm-btn" onclick="deleteLogsByDays()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                <button id="delete-days-cancel-btn" onclick="cancelDeleteDays()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Usuń logi z okresu:</label><br>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="date" id="delete-start-date" class="input-settings">
                    <span>do</span>
                    <input type="date" id="delete-end-date" class="input-settings">
                    <button id="delete-range-btn" onclick="showDeleteRangeConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Usuń</button>
                    <button id="delete-range-confirm-btn" onclick="deleteLogsByRange()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                    <button id="delete-range-cancel-btn" onclick="cancelDeleteRange()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
                </div>
            </div>
            <div>
                <button id="clear-all-btn" onclick="showClearAllConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Wyczyść wszystkie logi</button>
                <button id="clear-all-confirm-btn" onclick="clearAllLogs()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                <button id="clear-all-cancel-btn" onclick="cancelClearAll()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
                <button onclick="hideLogManagement()" class="rooms-button" style="background: #6c757d; color: white; margin-left: 10px;">Zamknij</button>
            </div>
        </div>
        
        <div class="logs-container" id="logs-container">
            {% for log in management_logs %}
            <div class="log-entry">
                <span class="log-timestamp">{{ log.timestamp }}</span>
                <span class="log-level {{ log.level }}">{{ log.level.upper() }}</span>
                <span class="log-message">{{ log.message }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Funkcje do odświeżania danych
function refreshDeviceStates() {
    fetch('/api/admin/device-states')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('device-states');
            container.innerHTML = '';
            data.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.innerHTML = `
                    <span>${device.name} (${device.room})</span>
                    <span class="device-status ${device.state ? 'online' : 'offline'}">
                        ${device.state ? 'Włączone' : 'Wyłączone'}
                    </span>
                `;
                container.appendChild(deviceItem);
            });
        })
        .catch(error => console.error('Error refreshing device states:', error));
}

function refreshLogs() {
    fetch('/api/admin/logs')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            data.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
                    <span class="log-message">${log.message}</span>
                `;
                container.appendChild(logEntry);
            });
        })
        .catch(error => console.error('Error refreshing logs:', error));
}

// Log management functions
function showLogManagement() {
    document.getElementById('log-management-panel').style.display = 'block';
}

function hideLogManagement() {
    document.getElementById('log-management-panel').style.display = 'none';
    // Reset all confirmation states when closing
    resetAllConfirmationStates();
}

// Confirmation state management functions
function showDeleteDaysConfirmation() {
    const days = document.getElementById('delete-days').value;
    if (!days || days < 1) {
        showNotification('Podaj poprawną liczbę dni', 'error');
        return;
    }
    
    document.getElementById('delete-days-btn').style.display = 'none';
    document.getElementById('delete-days-confirm-btn').style.display = 'inline-block';
    document.getElementById('delete-days-cancel-btn').style.display = 'inline-block';
}

function cancelDeleteDays() {
    document.getElementById('delete-days-btn').style.display = 'inline-block';
    document.getElementById('delete-days-confirm-btn').style.display = 'none';
    document.getElementById('delete-days-cancel-btn').style.display = 'none';
}

function showDeleteRangeConfirmation() {
    const startDate = document.getElementById('delete-start-date').value;
    const endDate = document.getElementById('delete-end-date').value;
    
    if (!startDate && !endDate) {
        showNotification('Podaj co najmniej jedną datę', 'error');
        return;
    }
    
    document.getElementById('delete-range-btn').style.display = 'none';
    document.getElementById('delete-range-confirm-btn').style.display = 'inline-block';
    document.getElementById('delete-range-cancel-btn').style.display = 'inline-block';
}

function cancelDeleteRange() {
    document.getElementById('delete-range-btn').style.display = 'inline-block';
    document.getElementById('delete-range-confirm-btn').style.display = 'none';
    document.getElementById('delete-range-cancel-btn').style.display = 'none';
}

function showClearAllConfirmation() {
    document.getElementById('clear-all-btn').style.display = 'none';
    document.getElementById('clear-all-confirm-btn').style.display = 'inline-block';
    document.getElementById('clear-all-cancel-btn').style.display = 'inline-block';
}

function cancelClearAll() {
    document.getElementById('clear-all-btn').style.display = 'inline-block';
    document.getElementById('clear-all-confirm-btn').style.display = 'none';
    document.getElementById('clear-all-cancel-btn').style.display = 'none';
}

function resetAllConfirmationStates() {
    cancelDeleteDays();
    cancelDeleteRange();
    cancelClearAll();
}

function deleteLogsByDays() {
    const days = document.getElementById('delete-days').value;
    
    fetch('/api/admin/logs/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({ days: parseInt(days) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs();
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting logs:', error);
        showNotification('Błąd podczas usuwania logów', 'error');
    })
    .finally(() => {
        cancelDeleteDays();
    });
}

function deleteLogsByRange() {
    const startDate = document.getElementById('delete-start-date').value;
    const endDate = document.getElementById('delete-end-date').value;
    
    const requestData = {};
    if (startDate) requestData.start_date = startDate;
    if (endDate) requestData.end_date = endDate;
    
    fetch('/api/admin/logs/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs();
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting logs:', error);
        showNotification('Błąd podczas usuwania logów', 'error');
    })
    .finally(() => {
        cancelDeleteRange();
    });
}

function clearAllLogs() {
    fetch('/api/admin/logs/clear', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs();
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing logs:', error);
        showNotification('Błąd podczas czyszczenia logów', 'error');
    })
    .finally(() => {
        cancelClearAll();
    });
}

// Proste wykresy energii
function createEnergyChart() {
    const canvas = document.getElementById('energyChart');
    const ctx = canvas.getContext('2d');
    
    // Symulowane dane zużycia energii (ostatnie 7 dni)
    const data = [12, 19, 8, 15, 25, 18, 22];
    const labels = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb', 'Nd'];
    
    const maxValue = Math.max(...data);
    const chartHeight = canvas.height - 40;
    const chartWidth = canvas.width - 40;
    const barWidth = chartWidth / data.length;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Rysowanie słupków
    ctx.fillStyle = '#4CAF50';
    data.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = 20 + index * barWidth;
        const y = canvas.height - 20 - barHeight;
        
        ctx.fillRect(x + 5, y, barWidth - 10, barHeight);
        
        // Etykiety
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[index], x + barWidth/2, canvas.height - 5);
        ctx.fillText(value + 'kWh', x + barWidth/2, y - 5);
        ctx.fillStyle = '#4CAF50';
    });
}

// Wykres automatyzacji
function createAutomationChart() {
    const canvas = document.getElementById('automationChart');
    const ctx = canvas.getContext('2d');
    
    // Dane dla wykresu kołowego: wykonane/nieudane automatyzacje
    const total = {{ stats.automations_executed_today }};
    const errors = {{ stats.automation_errors }};
    const successful = total - errors;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 60;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (total > 0) {
        // Udane wykonania
        const successAngle = (successful / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, successAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#4CAF50';
        ctx.fill();
        
        // Błędy
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, successAngle, 2 * Math.PI);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#f44336';
        ctx.fill();
        
        // Etykiety
        ctx.fillStyle = '#333';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${successful}/${total}`, centerX, centerY);
    } else {
        ctx.fillStyle = '#ccc';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Brak danych', centerX, centerY);
    }
}

// Inicjalizacja wykresów po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    createEnergyChart();
    createAutomationChart();
    
    // Auto-refresh co 30 sekund
    setInterval(() => {
        refreshDeviceStates();
        refreshLogs();
    }, 30000);
});
</script>
{% endblock %}