{% extends "base.html" %}

{% block title %}SmartHome - Dashboard Administratora{% endblock %}
{% block header %}Dashboard Administratora{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v={{ asset_version }}">
<style>
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}


.dashboard-card h3 {
    margin-top: 0;
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.stat-label {
    font-weight: bold;
    color: var(--text-secondary);
}

.stat-value {
    color: var(--text-primary);
}

.chart-container {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--card-bg);
    border-radius: 4px;
    margin: 10px 0;
    position: relative;
}

.chart-placeholder {
    color: var(--text-secondary);
    font-style: italic;
}

.logs-container {
    max-height: 300px;
    overflow-y: auto;
    background: var(--card-bg);
    border-radius: 4px;
    padding: 10px;
}

.log-entry {
    padding: 8px;
    margin: 5px 0;
    background: var(--accent);
    border-radius: 4px;
    border-left: 3px solid var(--accent-color);
    font-family: monospace;
    font-size: 0.9em;
}

.log-timestamp {
    color: var(--text-secondary);
    font-weight: bold;
}

.log-level {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
    margin: 0 5px;
}

.log-level.info {
    background: #d1ecf1;
    color: #0c5460;
}

.log-level.warning {
    background: #fff3cd;
    color: #856404;
}

.log-level.error {
    background: #f8d7da;
    color: #721c24;
}

.alert-msg {
    padding: 12px;
    margin: 15px 0;
    border-radius: 6px;
    font-size: 14px;
    display: none;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.refresh-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 10px;
}

.refresh-btn:hover {
    background: var(--accent-hover);
}

.device-list {
    max-height: 200px;
    overflow-y: auto;
}

.device-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    background: var(--card-bg);
    border-radius: 4px;
}

.device-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.device-status.online {
    background: #d4edda;
    color: #155724;
}

.device-status.offline {
    background: #f8d7da;
    color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-grid">
        <!-- Statystyki systemu -->
        <div class="dashboard-card">
            <h3>Statystyki Systemu</h3>
            <div class="stat-row">
                <span class="stat-label">Użytkownicy:</span>
                <span class="stat-value" id="users-count">{{ stats.users_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Urządzenia:</span>
                <span class="stat-value" id="devices-count">{{ stats.devices_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Automatyzacje:</span>
                <span class="stat-value" id="automations-count">{{ stats.automations_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Aktywne automatyzacje:</span>
                <span class="stat-value" id="active-automations">{{ stats.active_automations }}</span>
            </div>
        </div>

        <!-- Wykres zużycia energii -->
        <div class="dashboard-card">
            <h3>Zużycie Energii</h3>
            <div class="chart-container">
                <canvas id="energyChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Dzisiaj:</span>
                <span class="stat-value" id="energy-today">{{ stats.energy_today }} kWh</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ten miesiąc:</span>
                <span class="stat-value" id="energy-month">{{ stats.energy_month }} kWh</span>
            </div>
        </div>

        <!-- Historia stanów urządzeń -->
        <div class="dashboard-card">
            <h3>Stany Urządzeń</h3>
            <button class="refresh-btn" onclick="refreshDeviceStates(true)">Odśwież</button>
            <div class="device-list" id="device-states">
                {% for device in device_states %}
                <div class="device-item">
                    <span>{{ device.name }} ({{ device.room }})</span>
                    <span class="device-status {{ 'online' if device.state else 'offline' }}">
                        {{ 'Włączone' if device.state else 'Wyłączone' }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Statystyki automatyzacji -->
        <div class="dashboard-card">
            <h3>Automatyzacje</h3>
            <div class="chart-container">
                <canvas id="automationChart" width="300" height="150"></canvas>
            </div>
            <div class="stat-row">
                <span class="stat-label">Wykonane dzisiaj:</span>
                <span class="stat-value" id="automations-today">{{ stats.automations_executed_today }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Błędy:</span>
                <span class="stat-value" id="automation-errors">{{ stats.automation_errors }}</span>
            </div>
        </div>
    </div>

    <!-- Logi zarządzania -->
    <div class="dashboard-card">
        <h3>Logi Zarządzania</h3>
        <div style="margin-bottom: 15px;">
            <button class="refresh-btn" onclick="refreshLogs(true)">Odśwież logi</button>
            <button class="refresh-btn" onclick="showLogManagement()" style="background: #ffc107; margin-left: 10px;">Zarządzanie logami</button>
        </div>
        
        <!-- Log Management Panel (initially hidden) -->
        <div id="log-management-panel" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 4px;">
            <h4>Zarządzanie logami</h4>
            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <label>Usuń logi starsze niż:</label>
                <input type="number" id="delete-days" placeholder="liczba dni" min="1" class="input-settings" style="width: 100px;">
                <span>dni</span>
                <button id="delete-days-btn" onclick="showDeleteDaysConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Usuń</button>
                <button id="delete-days-confirm-btn" onclick="deleteLogsByDays()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                <button id="delete-days-cancel-btn" onclick="cancelDeleteDays()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Usuń logi z okresu:</label><br>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="date" id="delete-start-date" class="input-settings">
                    <span>do</span>
                    <input type="date" id="delete-end-date" class="input-settings">
                    <button id="delete-range-btn" onclick="showDeleteRangeConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Usuń</button>
                    <button id="delete-range-confirm-btn" onclick="deleteLogsByRange()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                    <button id="delete-range-cancel-btn" onclick="cancelDeleteRange()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
                </div>
            </div>
            <div>
                <button id="clear-all-btn" onclick="showClearAllConfirmation()" class="rooms-button" style="background: #dc3545; color: white;">Wyczyść wszystkie logi</button>
                <button id="clear-all-confirm-btn" onclick="clearAllLogs()" class="rooms-button" style="background: #dc3545; color: white; display: none;">Potwierdź</button>
                <button id="clear-all-cancel-btn" onclick="cancelClearAll()" class="rooms-button" style="background: #6c757d; color: white; display: none;">Anuluj</button>
                <button onclick="hideLogManagement()" class="rooms-button" style="background: #6c757d; color: white; margin-left: 10px;">Zamknij</button>
            </div>
        </div>
        
        <div class="logs-container" id="logs-container">
            {% for log in management_logs %}
            <div class="log-entry">
                <span class="log-timestamp">{{ log.timestamp }}</span>
                <span class="log-level {{ log.level }}">{{ log.level|upper }}</span>
                <span class="log-message">{{ log.message }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- User Management Section -->
    <div class="dashboard-card">
        <h3>Zarządzanie użytkownikami</h3>
        <div class="user-management">
            <div class="user-form">
                <h4>Wyślij zaproszenie</h4>
                <form id="inviteUserForm">
                    <div class="new-user-form">
                        <input class="input-settings-add-user" type="email" id="inviteEmail" name="email" placeholder="Email" required>
                        <select class="select-settings-add-user" id="inviteRole" name="role">
                            <option value="member">Członek</option>
                            <option value="admin">Administrator</option>
                            <option value="guest">Gość</option>
                        </select>
                        <button class="rooms-button" type="submit">Wyślij zaproszenie</button>
                    </div>
                </form>
                <div id="inviteMessage" class="alert-msg" style="display: none;"></div>
                
                <!-- Lista oczekujących zaproszeń -->
                <div style="margin-top: 20px;">
                    <h5 style="margin-bottom: 10px;">Oczekujące zaproszenia</h5>
                    <div id="pendingInvitationsContainer" style="max-height: 200px; overflow-y: auto;">
                        <!-- Będzie wypełnione dynamicznie -->
                    </div>
                </div>
            </div>
            <div class="user-form">
                <h4>Lista użytkowników</h4>
                <div id="userActionMessage" class="alert-msg" style="display: none;"></div>
                <div class="user-table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nazwa</th>
                                <th>E-mail</th>
                                <th>Rola</th>
                                <th>Hasło</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Tabela będzie wypełniona dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Management Section -->
    <div class="dashboard-card">
        <h3>Powiadomienia</h3>
        <div class="user-management two-column">
            <div class="user-form">
                <h4>Dodaj odbiorcę powiadomień</h4>
                <div class="new-user-form">
                    <input class="input-settings-add-user" type="email" id="notificationRecipientEmail" placeholder="e-mail" required>
                    <select class="select-settings-add-user" id="notificationRecipientUser"></select>
                    <button type="button" id="addNotificationRecipientBtn" class="rooms-button">Dodaj</button>
                </div>
                <div id="notificationsMessage" class="alert-msg" style="display: none;"></div>
            </div>
            <div class="user-form">
                <h4>Lista odbiorców powiadomień</h4>
                <div class="user-table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>E-mail</th>
                                <th>Użytkownik</th>
                                <th>Powiadomienia</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="notificationRecipientsTableBody">
                            <!-- Tabela będzie wypełniona dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.sessionRole = "{{ session.role }}";
</script>
<!-- Embed preloaded JSON data safely to avoid JS parsing issues in editors -->
<script id="preloadedDeviceStates" type="application/json">{{ device_states | tojson | safe }}</script>
<script id="preloadedManagementLogs" type="application/json">{{ management_logs | tojson | safe }}</script>
<script id="preloadedUsers" type="application/json">{{ preloaded_users | tojson | safe }}</script>
<!-- Hidden elements to store template data -->
<div id="stats-data" 
     data-automations-today="{{ stats.automations_executed_today|default(0) }}" 
     data-automation-errors="{{ stats.automation_errors|default(0) }}" 
     style="display: none;"></div>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Read embedded JSON into globals
const __getEmbeddedJSON = (id) => {
    const el = document.getElementById(id);
    if (!el) return null;
    try { return JSON.parse(el.textContent); } catch { return null; }
};
// Only set if not already defined
if (typeof window.preloadedDeviceStates === 'undefined') {
    window.preloadedDeviceStates = __getEmbeddedJSON('preloadedDeviceStates');
}
if (typeof window.preloadedManagementLogs === 'undefined') {
    window.preloadedManagementLogs = __getEmbeddedJSON('preloadedManagementLogs');
}
if (typeof window.preloadedUsers === 'undefined') {
    window.preloadedUsers = __getEmbeddedJSON('preloadedUsers');
}
// Funkcje do odświeżania danych
function refreshDeviceStates(forceRefresh = false) {
    // Use pre-loaded data on initial load, fetch from API only on manual refresh
    if (!forceRefresh && window.preloadedDeviceStates && window.preloadedDeviceStates.length > 0) {
        console.log('Using pre-loaded device states data');
        updateDeviceStatesDisplay(window.preloadedDeviceStates);
        // Clear pre-loaded data to prevent reuse
        window.preloadedDeviceStates = null;
        return;
    }
    
    console.log('Fetching device states from API');
    fetch('/api/admin/device-states')
        .then(response => response.json())
        .then(data => updateDeviceStatesDisplay(data))
        .catch(error => console.error('Error refreshing device states:', error));
}

function updateDeviceStatesDisplay(data) {
    const container = document.getElementById('device-states');
    container.innerHTML = '';
    data.forEach(device => {
        const deviceItem = document.createElement('div');
        deviceItem.className = 'device-item';
        deviceItem.innerHTML = `
            <span>${device.name} (${device.room})</span>
            <span class="device-status ${device.state ? 'online' : 'offline'}">
                ${device.state ? 'Włączone' : 'Wyłączone'}
            </span>
        `;
        container.appendChild(deviceItem);
    });
}

function refreshLogs(forceRefresh = false) {
    // Use pre-loaded data on initial load, fetch from API only on manual refresh
    if (!forceRefresh && window.preloadedManagementLogs && window.preloadedManagementLogs.length > 0) {
        console.log('Using pre-loaded management logs data');
        updateLogsDisplay(window.preloadedManagementLogs);
        // Clear pre-loaded data to prevent reuse  
        window.preloadedManagementLogs = null;
        return;
    }
    
    console.log('Fetching logs from API');
    fetch('/api/admin/logs')
        .then(response => response.json())
        .then(data => updateLogsDisplay(data))
        .catch(error => console.error('Error refreshing logs:', error));
}

function updateLogsDisplay(data) {
    const container = document.getElementById('logs-container');
    container.innerHTML = '';
    data.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-timestamp">${log.timestamp}</span>
            <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
            <span class="log-message">${log.message}</span>
        `;
        container.appendChild(logEntry);
    });
}

// Log management functions
function showLogManagement() {
    document.getElementById('log-management-panel').style.display = 'block';
}

function hideLogManagement() {
    document.getElementById('log-management-panel').style.display = 'none';
    // Reset all confirmation states when closing
    resetAllConfirmationStates();
}

// Confirmation state management functions
function showDeleteDaysConfirmation() {
    const days = document.getElementById('delete-days').value;
    if (!days || days < 1) {
        showNotification('Podaj poprawną liczbę dni', 'error');
        return;
    }
    
    document.getElementById('delete-days-btn').style.display = 'none';
    document.getElementById('delete-days-confirm-btn').style.display = 'inline-block';
    document.getElementById('delete-days-cancel-btn').style.display = 'inline-block';
}

function cancelDeleteDays() {
    document.getElementById('delete-days-btn').style.display = 'inline-block';
    document.getElementById('delete-days-confirm-btn').style.display = 'none';
    document.getElementById('delete-days-cancel-btn').style.display = 'none';
}

function showDeleteRangeConfirmation() {
    const startDate = document.getElementById('delete-start-date').value;
    const endDate = document.getElementById('delete-end-date').value;
    
    if (!startDate && !endDate) {
        showNotification('Podaj co najmniej jedną datę', 'error');
        return;
    }
    
    document.getElementById('delete-range-btn').style.display = 'none';
    document.getElementById('delete-range-confirm-btn').style.display = 'inline-block';
    document.getElementById('delete-range-cancel-btn').style.display = 'inline-block';
}

function cancelDeleteRange() {
    document.getElementById('delete-range-btn').style.display = 'inline-block';
    document.getElementById('delete-range-confirm-btn').style.display = 'none';
    document.getElementById('delete-range-cancel-btn').style.display = 'none';
}

function showClearAllConfirmation() {
    document.getElementById('clear-all-btn').style.display = 'none';
    document.getElementById('clear-all-confirm-btn').style.display = 'inline-block';
    document.getElementById('clear-all-cancel-btn').style.display = 'inline-block';
}

function cancelClearAll() {
    document.getElementById('clear-all-btn').style.display = 'inline-block';
    document.getElementById('clear-all-confirm-btn').style.display = 'none';
    document.getElementById('clear-all-cancel-btn').style.display = 'none';
}

function resetAllConfirmationStates() {
    cancelDeleteDays();
    cancelDeleteRange();
    cancelClearAll();
}

function deleteLogsByDays() {
    const days = document.getElementById('delete-days').value;
    
    fetch('/api/admin/logs/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({ days: parseInt(days) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs(true);
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting logs:', error);
        showNotification('Błąd podczas usuwania logów', 'error');
    })
    .finally(() => {
        cancelDeleteDays();
    });
}

function deleteLogsByRange() {
    const startDate = document.getElementById('delete-start-date').value;
    const endDate = document.getElementById('delete-end-date').value;
    
    const requestData = {};
    if (startDate) requestData.start_date = startDate;
    if (endDate) requestData.end_date = endDate;
    
    fetch('/api/admin/logs/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs(true);
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting logs:', error);
        showNotification('Błąd podczas usuwania logów', 'error');
    })
    .finally(() => {
        cancelDeleteRange();
    });
}

function clearAllLogs() {
    fetch('/api/admin/logs/clear', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            refreshLogs(true);
            hideLogManagement();
        } else {
            showNotification('Błąd: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing logs:', error);
        showNotification('Błąd podczas czyszczenia logów', 'error');
    })
    .finally(() => {
        cancelClearAll();
    });
}

// Proste wykresy energii
function createEnergyChart() {
    const canvas = document.getElementById('energyChart');
    const ctx = canvas.getContext('2d');
    
    // Symulowane dane zużycia energii (ostatnie 7 dni)
    const data = [12, 19, 8, 15, 25, 18, 22];
    const labels = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb', 'Nd'];
    
    const maxValue = Math.max(...data);
    const chartHeight = canvas.height - 40;
    const chartWidth = canvas.width - 40;
    const barWidth = chartWidth / data.length;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Rysowanie słupków
    ctx.fillStyle = '#4CAF50';
    data.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = 20 + index * barWidth;
        const y = canvas.height - 20 - barHeight;
        
        ctx.fillRect(x + 5, y, barWidth - 10, barHeight);
        
        // Etykiety
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[index], x + barWidth/2, canvas.height - 5);
        ctx.fillText(value + 'kWh', x + barWidth/2, y - 5);
        ctx.fillStyle = '#4CAF50';
    });
}

// Wykres automatyzacji
function createAutomationChart() {
    const canvas = document.getElementById('automationChart');
    const ctx = canvas.getContext('2d');
    
    // Dane dla wykresu kołowego: wykonane/nieudane automatyzacje
    const statsElement = document.getElementById('stats-data');
    const total = parseInt(statsElement.dataset.automationsToday) || 0;
    const errors = parseInt(statsElement.dataset.automationErrors) || 0;
    const successful = total - errors;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 60;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (total > 0) {
        // Udane wykonania
        const successAngle = (successful / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, successAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#4CAF50';
        ctx.fill();
        
        // Błędy
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, successAngle, 2 * Math.PI);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#f44336';
        ctx.fill();
        
        // Etykiety
        ctx.fillStyle = '#333';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${successful}/${total}`, centerX, centerY);
    } else {
        ctx.fillStyle = '#ccc';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Brak danych', centerX, centerY);
    }
}

// Safely use preloaded users once to prime UI, without overriding global loadUsers
function primeUsersFromPreload() {
    if (window.preloadedUsers && Array.isArray(window.preloadedUsers) && window.preloadedUsers.length > 0) {
        console.log('Priming users table with pre-loaded users data');
        if (typeof updateUsersTable === 'function') {
            updateUsersTable(window.preloadedUsers);
            // Keep notification users list in sync for selects
            if (typeof notificationUsersList !== 'undefined') {
                notificationUsersList = window.preloadedUsers;
            }
            if (typeof fillNotificationUserSelect === 'function') {
                fillNotificationUserSelect();
            }
        }
        // Clear pre-loaded data to prevent reuse
        window.preloadedUsers = null;
        return true;
    }
    return false;
}

// Wait for dashboard.js to load and then override functions
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin dashboard DOMContentLoaded - setting up optimization');
    
    // Initialize charts
    createEnergyChart();
    createAutomationChart();
    
    // Use pre-loaded data for initial rendering (no AJAX delay)
    console.log('Using pre-loaded data for device states and logs');
    refreshDeviceStates(false); // Use pre-loaded data
    refreshLogs(false); // Use pre-loaded data
    // Prime users table once with preloaded data if available
    const primed = primeUsersFromPreload();
    
    // Initialize dashboard with optimized loadUsers function (uses pre-loaded data first)
    if (typeof initDashboardPage === 'function') {
        console.log('Calling initDashboardPage with overridden loadUsers');
        initDashboardPage();
    }
    
    // Auto-refresh co 30 sekund (force refresh to get latest data)
    setInterval(() => {
        refreshDeviceStates(true);
        refreshLogs(true);
    }, 30000);

    // Load pending invitations
    loadPendingInvitations();
});

// ============================================================================
// INVITATION MANAGEMENT
// ============================================================================

// Handle invite form submission
document.getElementById('inviteUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('inviteEmail').value.trim();
    const role = document.getElementById('inviteRole').value;
    const homeId = '{{ session.current_home_id }}';
    
    if (!homeId) {
        showInviteMessage('Najpierw wybierz dom', 'error');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Wysyłanie...';
    
    fetch(`/api/home/${homeId}/invite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, role })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showInviteMessage('Zaproszenie zostało wysłane!', 'success');
            document.getElementById('inviteEmail').value = '';
            loadPendingInvitations(); // Reload invitations list
        } else {
            showInviteMessage(result.error || 'Wystąpił błąd podczas wysyłania zaproszenia', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showInviteMessage('Wystąpił błąd podczas wysyłania zaproszenia', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
    });
});

function loadPendingInvitations() {
    const homeId = '{{ session.current_home_id }}';
    if (!homeId) return;
    
    fetch(`/api/home/${homeId}/invitations`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                displayPendingInvitations(result.invitations);
            }
        })
        .catch(error => {
            console.error('Error loading invitations:', error);
        });
}

function displayPendingInvitations(invitations) {
    const container = document.getElementById('pendingInvitationsContainer');
    
    if (!invitations || invitations.length === 0) {
        container.innerHTML = '<p style="color: #999; font-style: italic; padding: 10px;">Brak oczekujących zaproszeń</p>';
        return;
    }
    
    container.innerHTML = invitations.map(inv => `
        <div style="padding: 10px; margin: 5px 0; background: var(--bg-secondary); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${inv.email}</strong>
                <span style="color: #999; font-size: 12px; margin-left: 10px;">
                    ${inv.role === 'admin' ? 'Administrator' : inv.role === 'member' ? 'Członek' : 'Gość'}
                </span>
                <br>
                <span style="font-size: 11px; color: #777;">
                    Kod: ${inv.invitation_code} | Wygasa: ${new Date(inv.expires_at).toLocaleDateString()}
                </span>
            </div>
            <button onclick="cancelInvitation('${inv.id}')" 
                    style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Anuluj
            </button>
        </div>
    `).join('');
}

function cancelInvitation(invitationId) {
    if (!confirm('Czy na pewno chcesz anulować to zaproszenie?')) return;
    
    const homeId = '{{ session.current_home_id }}';
    
    fetch(`/api/home/${homeId}/invitations/${invitationId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showInviteMessage('Zaproszenie anulowane', 'success');
            loadPendingInvitations();
        } else {
            showInviteMessage(result.error || 'Błąd podczas anulowania', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showInviteMessage('Błąd podczas anulowania zaproszenia', 'error');
    });
}

function showInviteMessage(message, type) {
    const msgDiv = document.getElementById('inviteMessage');
    msgDiv.textContent = message;
    msgDiv.className = `alert-msg alert-${type}`;
    msgDiv.style.display = 'block';
    
    setTimeout(() => {
        msgDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}