{% extends "base.html" %}

{% block title %}SmartHome - Dashboard Administratora{% endblock %}
{% block header %}Dashboard Administratora{% endblock %}

{% block content %}
    <div class="settings-container">
        <section class="settings-section">
            <h2>Statystyki Systemu</h2>
            <div class="user-form">
                <div class="stat-row">
                    <span class="stat-label">Użytkownicy:</span>
                    <span class="stat-value" id="users-count">{{ stats.users_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Urządzenia:</span>
                    <span class="stat-value" id="devices-count">{{ stats.devices_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Automatyzacje:</span>
                    <span class="stat-value" id="automations-count">{{ stats.automations_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Aktywne automatyzacje:</span>
                    <span class="stat-value" id="active-automations">{{ stats.active_automations }}</span>
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h2>Zużycie Energii</h2>
            <div class="user-form">
                <div class="chart-container">
                    <canvas id="energyChart" width="300" height="150"></canvas>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Dzisiaj:</span>
                    <span class="stat-value" id="energy-today">{{ stats.energy_today }} kWh</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Ten miesiąc:</span>
                    <span class="stat-value" id="energy-month">{{ stats.energy_month }} kWh</span>
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h2>Stany Urządzeń</h2>
            <div class="user-form">
                <button class="rooms-button" onclick="refreshDeviceStates()">Odśwież</button>
                <div class="device-list" id="device-states">
                    {% for device in device_states %}
                    <div class="device-item">
                        <span>{{ device.name }} ({{ device.room }})</span>
                        <span class="device-status {{ 'online' if device.state else 'offline' }}">
                            {{ 'Włączone' if device.state else 'Wyłączone' }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h2>Automatyzacje</h2>
            <div class="user-form">
                <div class="chart-container">
                    <canvas id="automationChart" width="300" height="150"></canvas>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wykonane dzisiaj:</span>
                    <span class="stat-value" id="automations-today">{{ stats.automations_executed_today }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Błędy:</span>
                    <span class="stat-value" id="automation-errors">{{ stats.automation_errors }}</span>
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h2>Logi Zarządzania</h2>
            <div class="user-form">
                <button class="rooms-button" onclick="refreshLogs()">Odśwież logi</button>
                <div class="logs-container" id="logs-container">
                    {% for log in management_logs %}
                    <div class="log-entry">
                        <span class="log-timestamp">{{ log.timestamp }}</span>
                        <span class="log-level {{ log.level }}">{{ log.level.upper() }}</span>
                        <span class="log-message">{{ log.message }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Funkcje do odświeżania danych
function refreshDeviceStates() {
    fetch('/api/admin/device-states')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('device-states');
            container.innerHTML = '';
            data.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.innerHTML = `
                    <span>${device.name} (${device.room})</span>
                    <span class="device-status ${device.state ? 'online' : 'offline'}">
                        ${device.state ? 'Włączone' : 'Wyłączone'}
                    </span>
                `;
                container.appendChild(deviceItem);
            });
        })
        .catch(error => console.error('Error refreshing device states:', error));
}

function refreshLogs() {
    fetch('/api/admin/logs')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            data.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level ${log.level}">${log.level.upper()}</span>
                    <span class="log-message">${log.message}</span>
                `;
                container.appendChild(logEntry);
            });
        })
        .catch(error => console.error('Error refreshing logs:', error));
}

// Proste wykresy energii
function createEnergyChart() {
    const canvas = document.getElementById('energyChart');
    const ctx = canvas.getContext('2d');
    
    // Symulowane dane zużycia energii (ostatnie 7 dni)
    const data = [12, 19, 8, 15, 25, 18, 22];
    const labels = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb', 'Nd'];
    
    const maxValue = Math.max(...data);
    const chartHeight = canvas.height - 40;
    const chartWidth = canvas.width - 40;
    const barWidth = chartWidth / data.length;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Rysowanie słupków
    ctx.fillStyle = '#4CAF50';
    data.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = 20 + index * barWidth;
        const y = canvas.height - 20 - barHeight;
        
        ctx.fillRect(x + 5, y, barWidth - 10, barHeight);
        
        // Etykiety
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[index], x + barWidth/2, canvas.height - 5);
        ctx.fillText(value + 'kWh', x + barWidth/2, y - 5);
        ctx.fillStyle = '#4CAF50';
    });
}

// Wykres automatyzacji
function createAutomationChart() {
    const canvas = document.getElementById('automationChart');
    const ctx = canvas.getContext('2d');
    
    // Dane dla wykresu kołowego: wykonane/nieudane automatyzacje
    const total = {{ stats.automations_executed_today }};
    const errors = {{ stats.automation_errors }};
    const successful = total - errors;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 60;
    
    // Czyszczenie canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (total > 0) {
        // Udane wykonania
        const successAngle = (successful / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, successAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#4CAF50';
        ctx.fill();
        
        // Błędy
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, successAngle, 2 * Math.PI);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#f44336';
        ctx.fill();
        
        // Etykiety
        ctx.fillStyle = '#333';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${successful}/${total}`, centerX, centerY);
    } else {
        ctx.fillStyle = '#ccc';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Brak danych', centerX, centerY);
    }
}

// Inicjalizacja wykresów po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    createEnergyChart();
    createAutomationChart();
    
    // Auto-refresh co 30 sekund
    setInterval(() => {
        refreshDeviceStates();
        refreshLogs();
    }, 30000);
});
</script>
{% endblock %}