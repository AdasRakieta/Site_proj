<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SmartHome{% endblock %}</title>
    <link rel="icon" href="{{ URL_PREFIX }}{{ url_for('static', filename='icons/site_icon.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script>
      (function() {
        try {
          var theme = localStorage.getItem('theme') || 'light';
          document.documentElement.setAttribute('data-theme', theme);
        } catch(e) {}
      })();
    </script>
    <link rel="stylesheet" href="{{ URL_PREFIX }}{{ url_for('static', filename='css/style.css') }}?v={{ asset_version }}">
    <link rel="stylesheet" href="{{ URL_PREFIX }}{{ url_for('static', filename='css/user_menu.css') }}?v={{ asset_version }}">
    <link rel="stylesheet" href="{{ URL_PREFIX }}{{ url_for('static', filename='css/home.css') }}?v={{ asset_version }}">
    <link rel="stylesheet" href="{{ URL_PREFIX }}{{ url_for('static', filename='css/mobile.css') }}?v={{ asset_version }}">
    {% block additional_styles %}{% endblock %}
</head>
<body>
    <script>
        window.toggleMenu = window.toggleMenu || function() {
            var sideMenu = document.getElementById('sideMenu');
            if (!sideMenu) {
                console.warn('Menu boczne nie zostalo znalezione');
                return;
            }
            sideMenu.classList.toggle('is-open');
        };
    </script>
    <div id="notifications-container"></div>
    
    <header>
        {% if request.endpoint != 'login' and request.endpoint != 'register' and request.endpoint != 'forgot_password' %}
        <button class="close-btn" onclick="toggleMenu()">
            <img id="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/menu_icon_light.png') }}" alt="Menu Toggle" class="menu-toggle">
        </button>
        {% endif %}
        <h1>{% block header %}Strona GÅ‚Ã³wna{% endblock %}</h1>
        <div class="user-menu-container">

            {% if request.endpoint != 'login' and request.endpoint != 'register' and request.endpoint != 'forgot_password' %}
            <div class="menu-handle" id="user-menu-handle" onclick="toggleUserMenu()">
                <img src="{{ user_data.profile_picture if user_data and user_data.profile_picture else URL_PREFIX + url_for('static', filename='profile_pictures/podstawowe.jpg') }}" alt="Profilowe" class="user-avatar" onerror="this.src='{{ URL_PREFIX }}{{ url_for('static', filename='profile_pictures/podstawowe.jpg') }}'">
            </div>
            <div class="main-menu" id="user-main-menu">
                <div class="menu-wrap">
                    <a href="/user" class="menu-item" style="margin-right: -15px;">
                        <img class="user-menu-icon" id="user-menu-user-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/user_icon_light.png') }}" alt="Profil">
                    </a>
                    {% if multi_home_enabled and user_homes %}
                    <div class="menu-item home-selector-item">
                        <div class="current-home-display" onclick="toggleHomeSelector()">
                            <img class="user-menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/home_icon_light.png') }}" alt="Home">
                            <span class="current-home-name">{{ current_home.name if current_home else 'Wybierz Dom' }}</span>
                            <span class="home-dropdown-arrow">â–¼</span>
                        </div>
                        <div class="home-selector-dropdown" id="home-selector-dropdown">
                            {% for home in user_homes %}
                            <div class="home-option {% if home.id == current_home_id %}active{% endif %}"
                                 onclick="switchHome('{{ home.id }}')">
                                <span class="home-name">{{ home.name }}</span>
                                {% if is_sys_admin %}
                                    <span class="home-role">Sys-Admin</span>
                                {% else %}
                                    <span class="home-role">{{ home.role }}</span>
                                    {% if home.is_owner %}
                                        <span class="home-owner-badge">ðŸ‘‘</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% endfor %}
                            <div class="home-selector-actions">
                                <a href="/home/select" class="home-action-link">ZarzÄ…dzaj Domami</a>
                                <a href="/home/create" class="home-action-link">UtwÃ³rz Nowy</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <a href="/settings" class="menu-item" style="margin-right: 15px;">
                        <img class="user-menu-icon" id="user-menu-settings-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/settings_icon_light.png') }}" alt="Ustawienia">
                    </a>
                        <a href="/logout" class="menu-item" style="margin-left: -30px;">
                        <img class="user-menu-icon" id="user-menu-logout-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/leave_icon.png') }}" alt="Wyloguj">
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </header>
    

    <div id="sideMenu" class="side-menu">
        <button style="margin-top: 18px;" class="close-btn" onclick="toggleMenu()">
            <img id="menu-icon-side" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/menu_icon_light.png') }}" alt="Menu Toggle" class="menu-toggle">
        </button>
        <nav style="margin-top: 55px;" class="menu">
            <ul>
                <li><a href="/" class="menu-link"><img id="home-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/home_icon_light.png') }}" alt="Home"> Strona GÅ‚Ã³wna</a></li>
                <li><a href="/lights" class="menu-link"><img id="lights-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/lights_icon_light.png') }}" alt="Lights"> ÅšwiatÅ‚a</a></li>
                <li><a href="/temperature" class="menu-link"><img id="temperature-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/temperature_icon_light.png') }}" alt="Temperature"> Temperatura</a></li>
                <li class="menu-item-with-submenu">
                    <a href="#" class="menu-link" onclick="toggleRoomsSubmenu(event)">
                        <img id="rooms-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/rooms_icon_light.png') }}" alt="Rooms"> Pokoje
                        <span class="submenu-arrow">â–¶</span>
                    </a>
                    <ul class="submenu" id="rooms-submenu">
                        {% for room in nav_rooms %}
                        <li><a href="/{{ room }}" class="submenu-link">{{ room }}</a></li>
                        {% endfor %}
                    </ul>
                </li>
                <li><a href="/security" class="menu-link"><img id="security-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/security_icon_light.png') }}" alt="Security"> Zabezpieczenia</a></li>
                <li><a href="/automations" class="menu-link"><img id="automations-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/automations_icon_light.png') }}" alt="Automations"> Automatyzacje</a></li>
                {% if has_admin_access %}
                <li><a href="/admin_dashboard" class="menu-link"><img id="dashboard-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/dashboard_icon_light.png') }}" alt="Dashboard"> Dashboard Admina</a></li>
                <li><a href="/edit" class="menu-link"><img id="edit-icon" class="menu-icon" src="{{ URL_PREFIX }}{{ url_for('static', filename='icons/edit_icon_light.png') }}" alt="Edit"> Edycja PrzyciskÃ³w</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
    </footer>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous"></script>
    <!-- Leaflet for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Home ID context -->
    <script>
        window.currentHomeId = "{{ current_home_id or '' }}";
        if (!window.currentHomeId) {
            window.currentHomeId = null;
        }
    </script>
    <script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/common.js') }}?v={{ asset_version }}"></script>
    <script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/app.js') }}?v={{ asset_version }}"></script>
    <script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/automations.js') }}?v={{ asset_version }}"></script>
    <script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/setup.js') }}?v={{ asset_version }}"></script>
    <script src="{{ URL_PREFIX }}{{ url_for('static', filename='js/user_menu.js') }}?v={{ asset_version }}"></script>
    
    <script>
        // Home Selector JavaScript
        function toggleHomeSelector() {
            const dropdown = document.getElementById('home-selector-dropdown');
            const arrow = document.querySelector('.home-dropdown-arrow');
            
            if (dropdown) {
                dropdown.classList.toggle('show');
                if (arrow) {
                    arrow.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }
        
        function switchHome(homeId) {
            // Show loading state
            const currentHomeName = document.querySelector('.current-home-name');
            const originalText = currentHomeName ? currentHomeName.textContent : '';

            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            if (currentHomeName) {
                currentHomeName.textContent = 'PrzeÅ‚Ä…czanie...';
            }
            
            // Send request to switch home
            fetch('/api/home/select', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                },
                body: JSON.stringify({ home_id: homeId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to reflect the new home context
                    window.location.reload();
                } else {
                    // Restore original text and show error
                    if (currentHomeName) {
                        currentHomeName.textContent = originalText;
                    }
                    alert('Nie udaÅ‚o siÄ™ przeÅ‚Ä…czyÄ‡ domu: ' + (data.error || 'Nieznany bÅ‚Ä…d'));
                }
            })
            .catch(error => {
                // Restore original text and show error
                if (currentHomeName) {
                    currentHomeName.textContent = originalText;
                }
                console.error('Error switching home:', error);
                alert('Nie udaÅ‚o siÄ™ przeÅ‚Ä…czyÄ‡ domu. SprÃ³buj ponownie.');
            });
            
            // Hide dropdown
            const dropdown = document.getElementById('home-selector-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const homeSelector = document.querySelector('.home-selector-item');
            const dropdown = document.getElementById('home-selector-dropdown');
            
            if (homeSelector && dropdown && !homeSelector.contains(event.target)) {
                dropdown.classList.remove('show');
                const arrow = document.querySelector('.home-dropdown-arrow');
                if (arrow) {
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        });

        // Rooms submenu toggle with smooth animation
        function toggleRoomsSubmenu(event) {
            event.preventDefault();
            const menuItem = event.target.closest('.menu-item-with-submenu');
            const submenu = menuItem.querySelector('.submenu');
            
            if (menuItem.classList.contains('active')) {
                // Closing animation
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                // Force reflow
                submenu.offsetHeight;
                submenu.style.maxHeight = '0px';
                
                // Remove active class after animation
                setTimeout(() => {
                    menuItem.classList.remove('active');
                }, 350);
            } else {
                // Opening animation
                menuItem.classList.add('active');
                submenu.style.maxHeight = '0px';
                // Force reflow
                submenu.offsetHeight;
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                
                // Set to none after animation to allow content to expand
                setTimeout(() => {
                    submenu.style.maxHeight = 'none';
                }, 350);
            }
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
