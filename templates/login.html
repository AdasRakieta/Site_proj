{% extends "base.html" %}

{% block title %}SmartHome - Logowanie{% endblock %}
{% block header %}Logowanie{% endblock %}

{% block content %}
    
    <div class="login-container">
        <form class="login-form" method="POST" action="{{ url_for('login') }}">
            <div class="form-group">
                <label for="username">Nazwa użytkownika</label>
                <input type="text" id="username" name="username" required>
            </div>

            <div class="form-group">
                <label for="password">Hasło</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="remember-me-container">
                <label class="checkbox-notification-label" for="remember_me">
                    <input type="checkbox" id="remember_me" name="remember_me" class="checkbox-notification">
                    <span class="checkbox-notification-custom">
                        <svg viewBox="0 0 13 10"><polyline points="1 5.5 5 9 12 1"></polyline></svg>
                    </span>
                    <span class="checkbox-notification-text">Zapamiętaj mnie</span>
                </label>
            </div>
            <div class="register-form">
                <p><a href="{{ url_for('forgot_password') }}">Zapomniałeś hasła?</a></p>
                <div class="login-buttons-row">
                    <button type="submit" style="margin-right: 25px;" class="login-btn">Zaloguj</button>
                    <button type="button" class="register-btn" id="registerBtn">Zarejestruj się</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function initPage() {
        console.log('Inicjalizacja strony logowania');
        
        if (!window.app) {
            console.error('Aplikacja nie została poprawnie zainicjalizowana');
            return;
        }
    }

    // Funkcje do zarządzania zapamiętywaniem danych użytkownika
    function saveUserData(username, rememberMe) {
        if (rememberMe) {
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('savedUsername', username);
        } else {
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('savedUsername');
        }
    }

    function loadUserData() {
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        const savedUsername = localStorage.getItem('savedUsername');
        
        if (rememberMe && savedUsername) {
            const usernameField = document.getElementById('username');
            const rememberCheckbox = document.getElementById('remember_me');
            
            if (usernameField) {
                usernameField.value = savedUsername;
            }
            if (rememberCheckbox) {
                rememberCheckbox.checked = true;
            }
        }
    }

    // Wyświetlenie komunikatów flash jako notyfikacji
    document.addEventListener('DOMContentLoaded', () => {
        // Obsługa przycisku rejestracji
        const registerBtn = document.getElementById('registerBtn');
        if (registerBtn) {
            registerBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('register') }}";
            });
        }
        // Wyświetl komunikaty flash jako notyfikacje
        const messages = JSON.parse('{{ get_flashed_messages(with_categories=true) | tojson | safe }}');
        if (messages && Array.isArray(messages)) {
            messages.forEach(([category, message]) => {
                window.showNotification(message, category);
            });
        }

        // Załaduj zapamiętane dane użytkownika
        loadUserData();

        // Obsługa formularza logowania
        const loginForm = document.querySelector('.login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                const username = document.getElementById('username').value;
                const rememberMe = document.getElementById('remember_me').checked;
                
                // Zapisz dane użytkownika jeśli checkbox jest zaznaczony
                saveUserData(username, rememberMe);
            });
        }
    });

</script>
{% endblock %}