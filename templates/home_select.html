{% extends "base.html" %}

{% block title %}Wybierz Dom - SmartHome{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home_select.css') }}">
{% endblock %}


{% block content %}
<div class="home-selection-container">
    <div class="home-selection-header">
        <h1>Wybierz Dom</h1>
        <p>Wybierz, kt√≥rym domem chcesz zarzƒÖdzaƒá</p>
    </div>

    <div class="homes-grid">
        {% for home in homes %}
        <div class="home-card {% if home.id == current_home_id %}active{% endif %}" 
             onclick="selectHome('{{ home.id }}')">
            <div class="home-header">
                <h3>{{ home.name }}</h3>
                <div class="home-badges">
                    {% if home.is_owner %}
                        <span class="badge owner">W≈Ça≈õciciel</span>
                    {% else %}
                        <span class="badge role">{{ home.role.title() }}</span>
                    {% endif %}
                    {% if home.id == current_home_id %}
                        <span class="badge current">Aktualny</span>
                    {% endif %}
                </div>
            </div>
            
            {% if home.description %}
            <p class="home-description">{{ home.description }}</p>
            {% endif %}
            
            <div class="home-stats">
                <div class="stat">
                    <span class="stat-number">{{ home.room_count or 0 }}</span>
                    <span class="stat-label">Pokoje</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ home.device_count or 0 }}</span>
                    <span class="stat-label">UrzƒÖdzenia</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ home.user_count or 1 }}</span>
                    <span class="stat-label">U≈ºytkownicy</span>
                </div>
            </div>
            
            <div class="home-permissions">
                {% for permission in home.permissions %}
                    <span class="permission-tag">{{ permission.replace('_', ' ').title() }}</span>
                {% endfor %}
            </div>
            
            <div class="home-footer">
                <small>Do≈ÇƒÖczono: {{ home.joined_at.strftime('%B %Y') if home.joined_at else 'Nieznane' }}</small>
                <div class="home-footer-actions">
                    {% if home.is_owner %}
                        <a href="/home/{{ home.id }}/settings" onclick="event.stopPropagation(); return true;" class="btn-primary settings-btn" title="ZarzƒÖdzaj ustawieniami domu">
                            ‚öôÔ∏è Ustawienia
                        </a>
                    {% elif user_global_role != 'sys-admin' %}
                        <button onclick="leaveHome('{{ home.id }}', '{{ home.name }}', event)" class="leave-home-btn" title="Opu≈õƒá dom">
                            üö™ Opu≈õƒá
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not homes %}
    <div class="no-homes">
        <h3>Brak Dostƒôpnych Dom√≥w</h3>
        <p>Nie masz jeszcze dostƒôpu do ≈ºadnych dom√≥w.</p>
        <a href="/home/create" class="btn btn-primary">Utw√≥rz Sw√≥j Pierwszy Dom</a>
    </div>
    {% endif %}

    <div class="home-actions">
        <button href="/home/create" class="btn-primary">
            üè† Utw√≥rz Nowy Dom
        </button>
        <button href="/home/join" class="btn-primary">
            üë• Do≈ÇƒÖcz do Domu
        </button>
    </div>
</div>



<script>
function selectHome(homeId) {
    console.log('üè† selectHome called with homeId:', homeId);
    
    // Show loading state
    const card = document.querySelector(`.home-card[onclick="selectHome('${homeId}')"]`);
    if (!card) {
        console.error('‚ùå Card not found for homeId:', homeId);
        return;
    }
    
    const originalContent = card.innerHTML;
    card.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p>Prze≈ÇƒÖczanie domu...</p></div>';
    
    console.log('üì§ Sending request to /api/home/select with homeId:', homeId);
    
    // Send request to switch home
    fetch('/api/home/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ home_id: homeId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to dashboard or previous page
            const returnUrl = new URLSearchParams(window.location.search).get('return') || '/';
            window.location.href = returnUrl;
        } else {
            // Restore card content and show error
            card.innerHTML = originalContent;
            alert('Nie uda≈Ço siƒô prze≈ÇƒÖczyƒá domu: ' + (data.error || 'Nieznany b≈ÇƒÖd'));
        }
    })
    .catch(error => {
        // Restore card content and show error
        card.innerHTML = originalContent;
        console.error('Error switching home:', error);
        alert('Nie uda≈Ço siƒô prze≈ÇƒÖczyƒá domu. Spr√≥buj ponownie.');
    });
}

function leaveHome(homeId, homeName, event) {
    // Prevent card click event from firing
    event.stopPropagation();
    
    const btn = event.target;
    
    // Check if already in confirm state
    if (btn.classList.contains('confirm-state')) {
        // User clicked confirm - proceed with leaving
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Opuszczanie...';
        btn.classList.remove('confirm-state');
        
        // Send request to leave home
        fetch(`/api/home/${homeId}/leave`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'Pomy≈õlnie opuszczono dom', 'success');
                } else {
                    alert(data.message || 'Pomy≈õlnie opuszczono dom');
                }
                
                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                // Restore button and show error
                btn.disabled = false;
                btn.innerHTML = 'üö™ Opu≈õƒá';
                
                if (typeof showNotification === 'function') {
                    showNotification(data.error || 'Nie uda≈Ço siƒô opu≈õciƒá domu', 'error');
                } else {
                    alert(data.error || 'Nie uda≈Ço siƒô opu≈õciƒá domu');
                }
            }
        })
        .catch(error => {
            // Restore button and show error
            btn.disabled = false;
            btn.innerHTML = 'üö™ Opu≈õƒá';
            console.error('Error leaving home:', error);
            
            if (typeof showNotification === 'function') {
                showNotification('B≈ÇƒÖd podczas opuszczania domu. Spr√≥buj ponownie.', 'error');
            } else {
                alert('B≈ÇƒÖd podczas opuszczania domu. Spr√≥buj ponownie.');
            }
        });
    } else {
        // First click - change to confirm state
        btn.classList.add('confirm-state');
        btn.innerHTML = '‚úì Potwierd≈∫';
        btn.title = `Kliknij ponownie aby potwierdziƒá opuszczenie "${homeName}"`;
        
        // Reset to normal state after 3 seconds if not clicked
        setTimeout(() => {
            if (btn.classList.contains('confirm-state')) {
                btn.classList.remove('confirm-state');
                btn.innerHTML = 'üö™ Opu≈õƒá';
                btn.title = 'Opu≈õƒá dom';
            }
        }, 3000);
    }
}

// Add loading spinner styles
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--accent-color);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}