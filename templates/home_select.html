{% extends "base.html" %}

{% block title %}Select Home - SmartHome{% endblock %}

{% block content %}
<div class="home-selection-container">
    <div class="home-selection-header">
        <h1>Select Home</h1>
        <p>Choose which home you want to manage</p>
    </div>

    <div class="homes-grid">
        {% for home in homes %}
        <div class="home-card {% if home.id == current_home_id %}active{% endif %}" 
             onclick="selectHome('{{ home.id }}')">
            <div class="home-header">
                <h3>{{ home.name }}</h3>
                <div class="home-badges">
                    {% if home.is_owner %}
                        <span class="badge owner">Owner</span>
                    {% else %}
                        <span class="badge role">{{ home.role.title() }}</span>
                    {% endif %}
                    {% if home.id == current_home_id %}
                        <span class="badge current">Current</span>
                    {% endif %}
                </div>
            </div>
            
            {% if home.description %}
            <p class="home-description">{{ home.description }}</p>
            {% endif %}
            
            <div class="home-stats">
                <div class="stat">
                    <span class="stat-number">{{ home.room_count or 0 }}</span>
                    <span class="stat-label">Rooms</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ home.device_count or 0 }}</span>
                    <span class="stat-label">Devices</span>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ home.user_count or 1 }}</span>
                    <span class="stat-label">Users</span>
                </div>
            </div>
            
            <div class="home-permissions">
                {% for permission in home.permissions %}
                    <span class="permission-tag">{{ permission.replace('_', ' ').title() }}</span>
                {% endfor %}
            </div>
            
            <div class="home-footer">
                <small>Joined: {{ home.joined_at.strftime('%B %Y') if home.joined_at else 'Unknown' }}</small>
                {% if home.is_owner %}
                    <a href="/home/{{ home.id }}/settings" class="settings-link">‚öôÔ∏è Settings</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not homes %}
    <div class="no-homes">
        <h3>No Homes Available</h3>
        <p>You don't have access to any homes yet.</p>
        <a href="/home/create" class="btn btn-primary">Create Your First Home</a>
    </div>
    {% endif %}

    <div class="home-actions">
        <a href="/home/create" class="btn btn-secondary">
            <i class="icon">üè†</i> Create New Home
        </a>
        <a href="/home/join" class="btn btn-secondary">
            <i class="icon">üë•</i> Join Home
        </a>
    </div>
</div>



<script>
function selectHome(homeId) {
    console.log('üè† selectHome called with homeId:', homeId);
    
    // Show loading state
    const card = document.querySelector(`.home-card[onclick="selectHome('${homeId}')"]`);
    if (!card) {
        console.error('‚ùå Card not found for homeId:', homeId);
        return;
    }
    
    const originalContent = card.innerHTML;
    card.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p>Switching home...</p></div>';
    
    console.log('üì§ Sending request to /api/home/select with homeId:', homeId);
    
    // Send request to switch home
    fetch('/api/home/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ home_id: homeId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to dashboard or previous page
            const returnUrl = new URLSearchParams(window.location.search).get('return') || '/';
            window.location.href = returnUrl;
        } else {
            // Restore card content and show error
            card.innerHTML = originalContent;
            alert('Failed to switch home: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        // Restore card content and show error
        card.innerHTML = originalContent;
        console.error('Error switching home:', error);
        alert('Failed to switch home. Please try again.');
    });
}

// Add loading spinner styles
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--accent-color);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}