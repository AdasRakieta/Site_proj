document.addEventListener('DOMContentLoaded',()=>{const step1=document.getElementById('step1');const step2=document.getElementById('step2');const form1=document.getElementById('registerProfileForm');const form2=document.getElementById('verificationForm');const backToStep1Btn=document.getElementById('backToStep1');let registrationData={};if(!form1||!form2)return;function showMessage(message,type='error'){let msgDiv=document.getElementById('registerMessage');if(!msgDiv){msgDiv=document.createElement('div');msgDiv.id='registerMessage';msgDiv.className='alert-msg';const activeStep=step1.style.display==='none'?step2:step1;const activeForm=step1.style.display==='none'?form2:form1;activeForm.insertBefore(msgDiv,activeForm.firstChild);}
msgDiv.textContent=message;msgDiv.style.display='block';msgDiv.style.color=type==='success'?'green':'crimson';setTimeout(()=>{msgDiv.style.display='none';},5000);}
function getCSRFToken(){let csrfToken=null;const input=document.querySelector('input[name="_csrf_token"]');if(input)csrfToken=input.value;if(!csrfToken){const meta=document.querySelector('meta[name="csrf-token"]');if(meta)csrfToken=meta.getAttribute('content');}
return csrfToken;}
function showStep2(){step1.style.display='none';step2.style.display='block';const oldMsg=document.getElementById('registerMessage');if(oldMsg)oldMsg.remove();document.getElementById('verificationCode').focus();}
function showStep1(){step2.style.display='none';step1.style.display='block';const oldMsg=document.getElementById('registerMessage');if(oldMsg)oldMsg.remove();}
form1.addEventListener('submit',async(e)=>{e.preventDefault();const username=document.getElementById('registerName').value.trim();const email=document.getElementById('registerEmail').value.trim();const password=document.getElementById('newPassword').value;const confirmPassword=document.getElementById('confirmPassword').value;if(!username||username.length<3){showMessage('Nazwa użytkownika musi mieć co najmniej 3 znaki.');return;}
if(!email||!email.includes('@')){showMessage('Podaj poprawny adres email.');return;}
if(!password||password.length<6){showMessage('Hasło musi mieć co najmniej 6 znaków.');return;}
if(password!==confirmPassword){showMessage('Hasła nie są identyczne.');return;}
const csrfToken=getCSRFToken();if(!csrfToken){showMessage('Brak tokena CSRF. Odśwież stronę i spróbuj ponownie.');return;}
registrationData={username,password,email};try{const response=await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},credentials:'same-origin',body:JSON.stringify(registrationData)});const data=await response.json();if(response.ok&&data.status==='verification_sent'){if(typeof showNotification==='function'){showNotification('Kod weryfikacyjny wysłany na email!','success');}else{showMessage('Kod weryfikacyjny wysłany na email!','success');}
setTimeout(()=>{showStep2();},1000);}else{showMessage(data.message||'Wystąpił błąd podczas wysyłania kodu.');}}catch(error){showMessage('Błąd połączenia z serwerem.');}});form2.addEventListener('submit',async(e)=>{e.preventDefault();const verificationCode=document.getElementById('verificationCode').value.trim();if(!verificationCode||verificationCode.length!==6){showMessage('Wprowadź 6-cyfrowy kod weryfikacyjny.');return;}
if(!/^\d{6}$/.test(verificationCode)){showMessage('Kod weryfikacyjny musi składać się z 6 cyfr.');return;}
const csrfToken=getCSRFToken();if(!csrfToken){showMessage('Brak tokena CSRF. Odśwież stronę i spróbuj ponownie.');return;}
try{const response=await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},credentials:'same-origin',body:JSON.stringify({...registrationData,verification_code:verificationCode})});const data=await response.json();if(response.ok&&data.status==='success'){if(typeof showNotification==='function'){showNotification('Rejestracja zakończona sukcesem! Możesz się zalogować.','success');}else{showMessage('Rejestracja zakończona sukcesem! Możesz się zalogować.','success');}
const urlParams=new URLSearchParams(window.location.search);const next=urlParams.get('next');const loginUrl=next?`/login?next=${encodeURIComponent(next)}`:'/login';setTimeout(()=>{window.location.href=loginUrl;},1500);}else{showMessage(data.message||'Wystąpił błąd podczas weryfikacji.');}}catch(error){showMessage('Błąd połączenia z serwerem.');}});backToStep1Btn.addEventListener('click',(e)=>{e.preventDefault();showStep1();});const returnBtns=document.querySelectorAll('.return-button');returnBtns.forEach(btn=>{if(btn.id!=='backToStep1'){btn.addEventListener('click',(e)=>{e.preventDefault();const urlParams=new URLSearchParams(window.location.search);const next=urlParams.get('next');const loginUrl=next?`/login?next=${encodeURIComponent(next)}`:'/login';window.location.href=loginUrl;});}});const verificationInput=document.getElementById('verificationCode');if(verificationInput){verificationInput.addEventListener('input',(e)=>{e.target.value=e.target.value.replace(/\D/g,'');});}});